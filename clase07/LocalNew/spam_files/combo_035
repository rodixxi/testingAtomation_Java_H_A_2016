YUI.add("mail-models-serializers-draft-messageV3-unserializer",function(e){var t=function(){};e.mix(t.prototype,{update:function(t,n){var r,i,s;s=e.common.Utils.getVal(n,"result.message"),s&&(r=e.common.Utils.getVal(s,"spame",null),t.setSpame(r?r:"U"),i=e.common.Utils.getVal(s,"csid",null),i&&(t.csid=i))}}),e.namespace("Mail.Models.Serializers").DraftMessageV3Unserializer=t},"1.0.0",{requires:["common-utils"]});
YUI.add("mail-controller-messages-ops",function(e){function E(t,n,r){var i=n.method,s="passive";NeoGV.isYdod&&(o.settings.value("ydodActiveAPI",[]).indexOf(i)>-1&&(s="active"),e.fire("util:ymstats",{name:"ydodBlock",tags:{api:i,mode:s},include:{farm:!0}}),s==="active"&&r("failure"))}function S(e,t,n){var r,o,u=t.parms,a=t.reason,f=t.api,l=e.error,p,d,v;if(NeoConfig.scanMoveAction&&t.method==="MoveMessages")for(o=0;o<u.mid.length;o++)p=!1,u.mid[o]&&(v=typeof u.mid[o],v==="string"?p=H(u.mid[o]):v==="object"&&u.mid[o].hashKey?p=u.mid[o].hashKey:v==="object"&&u.mid[o].mid&&(p=H(u.mid[o].mid))),p&&b[p]&&delete b[p];if(l)for(o=0;o<l.length;o++)if(l[o].code!=="WARN")return n("failure"),c._error(e,h.invalidmid);if(t&&t.origParms&&(t.origParms.sourceFid&&t.origParms.sourceFid==="%40S%40Search"||t.origParms.fromSearch)||e&&e.fromSearch)d=d||{},d.fromSearch=!0;t&&t.origParms&&t.origParms.fromConv&&(d=d||{},d.fromConv=!0),(a==="remove"||a==="move")&&u.mid&&u.mid.length>200&&s.remove(u.sourceFid||u.fid,e.mid,!u.destinationFid,u.destinationFid,d),f==="move"&&!e.fromSearch&&u.mid&&u.mid.length&&s.move(u.sourceFid,u.destinationFid,u.mid,e.mid,a,d),r=e.sourceFolder,r&&t.custom.isSparse&&i.Folders.set(r,"ds:msg:",1),r=e.destinationFolder,r&&i.Folders.set(r,"ds:msg:",1)}function x(e,t){var n=e.destinationFid&&w.isSpamFid(e.destinationFid),r=t.origParms,i=r.destinationFid,o=r.sourceFid,u=t.origParms.mid,a,f,l;if(n){a={},w.isSpamFid(i)&&(a[g.spam]=1,a[g.ham]=0),w.isSpamFid(o)&&!w.isTrashFid(i)&&(a[g.ham]=1,a[g.spam]=0),s.update(e.sourceFid||e.fid,u,{flags:a},"flag");if(y)for(f=0;f<u.length;f++)u[f].flags.isRead=1}if(t&&t.origParms&&(t.origParms.sourceFid&&t.origParms.sourceFid==="%40S%40Search"||t.origParms.fromSearch)||e&&e.fromSearch)l=l||{},l.fromSearch=!0;t&&t.origParms&&t.origParms.fromConv&&(l=l||{},l.fromConv=!0),u.length<=200&&s.remove(e.sourceFid||e.fid,u,!e.destinationFid,e.destinationFid,l)}function T(e,t,n){var r=t.origParms,i,s=e.returnCodes;if(s&&s.length){for(i=0;i<s.length;i++)if(s[i].code!=="WARN")return n("failure"),c._error(e,h.invalidmid)}else r.mid?t.custom.isSparse&&N(r.setFlags,"read")&&!t.noRefresh&&!NeoConfig.hasConvView&&a.refresh():a.refresh()}function N(e,t){return e&&t in e}function C(e,t){var n,r,i=e.setFlags;if(t.origParms.chain)return;r={};for(n in i)r[g[n]]=i[n];r[g.spam]?r[g.ham]=0:r[g.ham]&&(r[g.spam]=0),f.isUndefined(i.spam)&&t.reason!=="move"&&s.update(e.fid,t.origParms.mid||[],{flags:r},t.reason)}function k(e,t){var n,r={},i,o,u=[],a={},l=t.parms,c=t.origParms.mid||[],h=e&&e.data&&e.data.returnCodes||[],p=l.setFlags;for(n in p)n==="read"&&(a[g[n]]=p[n]?0:1);if(!f.isUndefined(p.read)){for(i=0;i<c.length;i++)r[c[i].mid]=c[i];for(i=0;i<h.length;i++)o=r[h[i].mid],o&&u.push(o);s.update(l.fid,u,{flags:a},t.reason)}}function L(e,t){var n,r=0,i=t.origParms.mid;while(i[r])n=i[r++],n.header||(t.custom.isSparse=1)}function A(e,t){return t("failure"),c._error({},h.invalidparams)}function O(e,t){var n=0,r=e.mid;if(t)return e.mid=f.isArray(r)?r[0].mid:r.mid,1;f.isArray(r)||(r=r?[r]:[]),e.mid=[];for(;n<r.length;n++)e.mid[n]=r[n].mid||r[n];return n||e.selection}function M(t,r,i){var s=f.isArray(t.mid)?t.mid:new Array(t.mid),a,l,c,h={},p,v,m,g,y,b=[],E=10,S=t.sourceFid,x=S||t.fid;if(x==="%40S%40Search"){t.enableRetry=!0;if(!s[0])return;for(l=0,a=s.length;l<a;l++){p=s[l].fid||x;if(x==="%40S%40Search"||r.api!=="move"||!w.isDraftFid(p)&&!w.isSentFid(p)||!!w.isTrashFid(t.destinationFid))h[p]||(h[p]=[]),h[p].push(s[l])}if((m=o.size(h))===1&&p==="%40S%40Search")return;if(r.api==="remove"&&x==="%40S%40Search"){t.sourceFid=t.sourceFid||t.fid,delete t.fid,t.destinationFid=d,r.newApi("move","MoveMessages",t),i("pre","move"),i(1,t);return}delete t.mids;for(l in h)y=e.clone(t),S?y.sourceFid=l:y.fid=l,y.mid=h[l],t.sourceFid==="%40S%40Search"&&(y.fromSearch=!0),b[b.length]=y;o.assert(m===b.length);if(!(m>1))return b[0];var T=i(function(){r.cbk.abort()});g=Math.ceil(m/E);for(c=0;c<g;c++){v=u.batch().Messages;for(l=c*E;l<m&&l<c*E+E;l++)l===m-1?v[r.api](b[l],{success:function(e){T(e,"success",n.usercbk)},failure:function(e){T(e,"failure",n.usercbk)}}):v[r.api](b[l]);v.execute()}}}function _(e,t){var n=e.mid,r=e.fid;r==="%40S%40Search"&&(e.enableRetry=!0,n.fid&&n.fid!==r&&(e.fid=n.fid),O(e,t.api==="fullHeader"))}function D(t,n,r){var i=t.mid,u=t.setFlags,a=0,l=t.mid=[],c=w.isSpamFid(t.fid),h,p,d,m,b,E,S,x,T,N,C,k,L,M,_;if(o.isEmpty(u))return A(n,r);f.isArray(i)||(i=i?[i]:[]);if(u.spam&&!c||u.ham&&c||u.sendercompromised&&t.fid!==v||u.phished&&t.fid!==v||u.notmymail)d=1;while(i[a]){h=i[a++];if(!o.isEmpty(h.flags)){h=s.get(t.fid,h.mid)||h;for(p in u){if(h.flags[g[p]]!==u[p]||d){l.push(h);break}if(p==="read"){C=e.all('.thread-item[data-mid="'+s.getPermMidPart(h.mid)+'"]'),k=C.size();for(L=0;L<k;L++){_=h.flags[g.read]?0:1,M=C.item(L).hasClass("unread")?1:0;if(_!==M){l.push(h),o.log({m:"DS does not reflect UI for msg",mid:h.mid},!1,"InterruptBypassed");break}}}}}else l.push(h),n.custom.isSparse=1}if(i.length&&!l.length){r("success");return}if(!O(t))return A(n,r);!t.spam&&((S=u.notmymail)||(m=u.spam)||(b=u.sendercompromised)||(E=u.phished)||u.ham)&&(x=n.getBatch(),N=m||b||E||S?v:t.destinationFid||"Inbox",t.isImapIn&&(N=t.destinationFid,delete t.isImapIn),delete t.destinationFid,T={sourceFid:t.fid,destinationFid:N,mid:i||n.origParms.mid,spam:1,enableRetry:t.enableRetry||!1},t.fromConv&&(T.fromConv=t.fromConv),n.noRefresh=1,(b||E)&&!S&&y&&(u.read=1),r(1,t),x.Messages.move(T),x.execute(n.cbk)),delete t.spam}function P(e,t,n){var r,i,s=e.destinationFid,o=e.sourceFid,u,a;e.mid=e.mid?e.mid:[],u={fid:o,mid:f.isArray(e.mid)?e.mid:[e.mid],spam:1,enableRetry:e.enableRetry||!1},a=function(){var t,r=e.mid.length;if(r>100)return;for(var i=0;i<r;i++)t=e.mid[i]&&e.mid[i].mid&&H(e.mid[i].mid),t&&b[t]?n("failure"):b[t]=!0};if(s===o){n("success");return}e.spam||(w.isSpamFid(s)&&(i=u.setFlags={spam:1},y&&(i.read=1)),w.isSpamFid(o)&&!w.isTrashFid(s)&&(i=u.setFlags={ham:1})),!i&&NeoConfig.scanMoveAction&&a(),i&&(t.newApi("flag","FlagMessages"
,u),r=t.getBatch(),t.noRefresh=1,n("pre","flag"),n(1,u),e.spam=1,e.bidiDetection=NeoConfig.bidi,r.Messages.move(e),r.execute(t.cbk)),delete e.spam;if(!O(e))return A(t,n)}function H(e){var t=e.split("_");return t[t.length-1]}function B(e,t,n){var r=e.fid;if(!w.isTrashFid(r)&&!w.isDraftFid(r)&&!w.isSpamFid(r)&&e.fid!==p&&!e.force)return e.sourceFid=e.fid,delete e.fid,e.destinationFid=d,e.isImapIn&&(e.destinationFid=e.destFid,delete e.isImapIn),t.api=t.reason="move",t.method=l.passthru.move,n("pre","move"),e;delete e.force;if(!O(e))return A(t,n)}function j(t,n){NeoConfig.scanMoveAction&&n.method==="MoveMessages"&&t.fault==="aborted"&&(b=[]);if(t&&t.reason===h.invalidparams)return;n.parms.sourceFid&&s.flush(0,1),e.later(500,a,a.refresh)}function F(e,t){if(e&&e.reason===h.invalidparams)return;var n=t.parms;"read"in n.setFlags?a.refresh():s.flush(n.fid)}var t,n,r=e.mail,i=r.model.DataStore,s=i.Messages,o=e.common.Utils,u=r.Controller,a=u.Folders,f=e.Lang,l={passthru:{move:"MoveMessages",flag:"FlagMessages",remove:"DeleteMessages",fullHeader:"GetMessageRawHeader",redirectMsg:"RedirectMessage",addFilter:"AddFilters"},isdup:{FlagMessages:function(e,t){var n=e.setFlags,r=t.setFlags;if(e.mid&&t.mid&&e.mid.length===1&&t.mid.length===1&&e.mid[0]===t.mid[0]&&n.read===r.read&&n.flagged===r.flagged)return!0}}},c,h,p="%40C%40Chats",d="Trash",v="%40B%40Bulk",m="Draft",g={replied:"isReplied",flagged:"isFlagged",read:"isRead",draft:"isDraft",forwarded:"isForwarded",ham:"isHam",spam:"isSpam",notmymail:"notmymail"},y=strings.str_cfg_tog_set_spam_read_flag,b={},w=e.mail.ui.FolderUtils;l.batchable=l.passthru,c=u.extend("Messages",l),h=c.Error,n=l.order,e.mix(c,{fixFlagHook:D}),t={success:S,failure:j},c.hook({move:t,remove:t,flag:{success:T,failure:F}}),t={pre:x},c.hook({move:t,remove:t},0,n.optimistic),c.hook({move:{pre:M},remove:{pre:M},flag:{pre:M},fullHeader:{pre:_},redirectMsg:{pre:M}},0,n.fixParms),c.hook({move:{pre:P,aborted:j},remove:{pre:B,aborted:j},flag:{pre:D,aborted:F},redirectMsg:{pre:function(e){O(e)}}},0,n.fixParms),c.hook({flag:{pre:E},move:{pre:E}},0,n.ydodCheck),c.hook({move:{pre:L},flag:{pre:C,failure:k}},0,n.optimistic),e.mix(h,{invalidmid:h._reservedIdx+1,invalidparams:h._reservedIdx+1,noitems:h._reservedIdx+2})},"3.0.0",{requires:["mail-controller-base","mail-model-datastore","json-stringify","mail-ui-folder-utils","mail-common-utils-settings"]});
YUI.add("mail-services-response-serializer",function(e){function i(e){this.didGDM=!1,this.didSave=!1,this.didSend=!1,e&&(this.didSave=e.doSave,this.didGDM=e.doGDM,this.didSend=e.doSend)}var t="SendMessage",n="SaveMessage",r="GetDisplayMessage";e.mix(i.prototype,{unWrapSaveSuccess:function(e){var t=e.result.responses[0];return t&&t.id!==n?Promise.reject({}):t.httpCode>=200&&t.httpCode<300?t.response:Promise.reject({status:t.httpCode,res:{status:t.httpCode,response:JSON.stringify(t),responseText:JSON.stringify(t)}})},unWrapSaveFailure:function(e){return Promise.reject(e)},unWrapSendSuccess:function(e){var i=this,s,o,u,a,f,l,c,h;for(c=0;c<e.result.responses.length;c++)switch(e.result.responses[c].id){case n:s=e.result.responses[c];break;case t:u=e.result.responses[c];break;case r:f=e.result.responses[c];break;default:}for(c=0;c<e.result.status.failedRequests.length;c++)switch(e.result.status.failedRequests[c].id){case n:o=e.result.status.failedRequests[c];break;case t:a=e.result.status.failedRequests[c];break;case r:l=e.result.status.failedRequests[c];break;default:}for(c=0;c<e.result.status.successRequests.length;c++)switch(e.result.status.successRequests[c].id){case n:o=e.result.status.successRequests[c];break;case t:a=e.result.status.successRequests[c];break;case r:l=e.result.status.successRequests[c];break;default:}return h={errDetail:e.error,url:e.url},i.didSave&&s&&(h.SaveMessage={headers:s.headers,httpCode:s.httpCode,id:s.id,response:s.response,status:o,success:!0},s.httpCode>=200&&s.httpCode<300||(h.SaveMessage.success=!1,h.errDetail=h.SaveMessage.error={code:s.httpCode,resource:e.url})),i.didSend&&u&&(h.SendMessage={headers:u.headers,httpCode:u.httpCode,id:u.id,response:u.response,status:a,success:!0},u.httpCode>=200&&u.httpCode<300||(h.SendMessage.success=!1,h.errDetail=h.SendMessage.error)),i.didGDM&&f&&(h.GetDisplayMessage={headers:f.headers,httpCode:f.httpCode,id:f.id,response:f.response,status:l,success:!0},f.httpCode>=200&&f.httpCode<300||(h.GetDisplayMessage.success=!1)),h},unWrapSendFailure:function(e){return Promise.reject(e)}}),e.namespace("Mail.Services").ResponseSerializer=i},"1.0.0",{requires:["common-utils","json","json-parse"]});
YUI.add("mail-services-compose",function(e){function h(n){t(n,"no V3 mailbox id supplied to compose service"),this.transport=new e.Mail.Core.Net.Transport(new e.Mail.Core.Net.Policies.ComposePolicy),this.v3url="/ws/v3/mailboxes/@.id=="+n+"/messages",this.mbid=n,this.gdmUnserializer=new e.Mail.Models.Serializers.DraftGdmUnserializer,this.attachmentRespPreprocessor=new e.Mail.Models.Serializers.AttachmentRespPreprocessor,this.msgUnserializer=new e.Mail.Models.Serializers.DraftMessageV3Unserializer}function p(t){var n=t.attachments.filter(function(e){return e.state()==="pending"&&e.size()!==0}),r=n.map(function(e){return e.contentId()});return e.Array.hash(r,n)}function d(e){var t=e.attachments.filter(function(e){return e.state()==="pending"&&e.isToFetchFromWeb()});return t}function v(t,n){t&&e.Object.each(t,function(e){e.transactionId=n.id})}function m(t,n){var r=n.loaded;t&&e.Object.each(t,function(e){e.progress=0;if(r>0&&e.file()){var t=r>e.file().size?1:r/e.file().size;r-=e.file().size,e.setProgress(t)}})}function g(e,t){e&&e.attachmentInfo&&t.loaded&&(e.attachmentInfo.bytesSent=Math.min(e.attachmentInfo.size,t.loaded))}function y(e,t){var n=!1;e.attachments.forEach(function(e){e.state()==="deleted"&&(n=!0,t.cancel(e.transactionId))}),n&&e.setState("unsaved")}function b(e,t){e.attachments.forEach(function(e){e.state()==="uploading"&&(t.cancel(e.transactionId),e.setState("pending"))})}function w(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&(n+=e[t].size());return n}function E(e){var t=Math.max(e*o,s);return t}function S(t,n,r){var i={contentInfo:t.getLogInfo()},s=n?e.Object.size(n):0;return s>0&&(i.attachmentInfo={count:s,size:r,bytesSent:0}),i}function x(t,n,r){var i,s,o,u;if(!r||e.Lang.isArray(r)&&r.length===0)e.Object.each(n,function(e){u=!0,e.setState("failed")});else for(s=0;s<r.length;s++){i=r[s],o=n[i.contentId];if(!o)continue;i.virus==="Y"?(o.setState("infected"),u=!0):o.setState("pending")}u&&t.setState("unsaved")}function T(e,t){t.forEach(function(t){var n=e.attachments.indexOf(t);n!==-1&&(e.attachments.splice(n,1),t.deleted())})}function N(t){if(t.draftToDelete){var n=function(){},r={success:n,failure:n,suppressNotification:!0};NeoConfig.yodaUpdateEnabled&&NeoConfig.yodaControllerLoaded?e.mail.controller.v3.api.deleteMessagesWithMid({messages:t.draftToDelete,sourceFid:"Draft",showTAE:!1}):e.mail.Controller.Messages.remove({fid:"Draft",mid:t.draftToDelete,force:!0},r),t.draftToDelete=void 0}}function C(e){var t=e.SaveMessage,r=e.SendMessage,i,s;return t&&r&&t.success&&!r.success&&(i=n(t,"response.result.message.captcha"),s=n(r,"response.error"),i&&s&&(s.code="batchCaptcha")),e}function k(e){var t,n,r;if(!e||!e.result||!e.result.simpleBody||!e.result.simpleBody.attachments)return!1;t=e.result.simpleBody.attachments;for(r=0;r<t.length;r++){n=t[r].virus;if(n&&n==="Y")return!0}return!1}function L(e,t){if(e.code)switch(e.code){case"ET-5012":k(t)&&(e.code="virusDetected");break;default:}return e}var t=e.common.Utils.verify,n=e.common.Utils.getVal,r=e.mail.Controller.convAdapter,i=e.mail.controller.v3.converter,s=35e3,o=10,u="SendMessage",a="SaveMessage",f=e.common.Utils.features.enabled("getSimpleBody"),l=!f,c=f?"GetSimpleBody":"GetDisplayMessage";e.mix(h.prototype,{save:function(t,i,s){var o=this,u,a,f=t.draftToDelete?t.draftToDelete:t.mid,l=p(t),c=d(t),h=c.length>=1,m=e.Object.size(l)>0,g=!0,b=t.attachments.filter(function(e){return e.state()==="deleted"});return y(t,this.transport),t.generateCsid(),!m&&g?u=this.jsonSave(t,s):window.FormData&&window.FileReader?h?(s.doSave=!0,u=this.formDataSaveWithWebAttachments(t,l,c,s)):u=this.formDataSave(t,l,s):u=this.iframeSave(t,l,s),v(l,u),u.then(function(n){return o.attachmentRespPreprocessor.preProcess({uploads:l,normalizedResponse:o._normalizeResponseObject(n),draft:t,saveSuccess:!0}),N(t),o.gdmUnserializer.update(t,l,n),o.msgUnserializer.update(t,n),o._updateDraftCaptcha(t,n),T(t,b),s.suppressDS||(o._autoFixV2MidInSaveResponse(n.result),a={method:"save",draft:t,draftMid:f,msgResponse:n.result.messageV2},r.store(a)),n},function(r){var i=o.attachmentRespPreprocessor.preProcess({uploads:l,normalizedResponse:o._normalizeResponseObject(n(r,"res.response")),draft:t,saveSuccess:!1});return x(t,l,i),r}),u},jsonSave:function(e,t){var n=this,r=e.jsonify(),i={options:{timeout:s},upload:!1,errHandler:L,suppressNotification:t&&t.suppressNotification,suppressStat:t&&t.suppressStat,api:"messages",logInfo:S(e)},o;return o=n.transport.request(n.v3url,r,i),o},getRequestConfig:function(t,n,r){var i=e.Object.size(n)>0,s=w(n),o=S(t,n,s);return{options:{progress:function(e,t){m(n,t),g(o,t)},timeout:E(s)},upload:i,errHandler:L,suppressNotification:r&&r.suppressNotification,suppressStat:r&&r.suppressStat,logInfo:o}},formDataSaveWithWebAttachments:function(t,n,r,i){var s=this,o,u,a=t.attachments.filter(function(e){return e.state()==="pending"&&e.size()!==0}),f,l="/ws/v3/batch",c=t.origin.action?!0:!1,h=e.Mail.Services,p;return f=(new e.Mail.Models.Serializers.DraftFormData(t)).batchData({saveUrl:s.v3url,v3BatchUrl:l,webAttachments:r,uploads:a,csid:i.csid,mbid:s.mbid,doSend:i.doSend||!1,doGDM:c,doSave:i.doSave}),o=this.getRequestConfig(t,n,i),u=this.transport.request(l,f,o),i.doSend?(p=new h.ResponseSerializer({doGDM:c,doSave:i.doSave,doSend:i.doSend}),u.then(p.unWrapSendSuccess.bind(p),p.unWrapSendFailure.bind(p))):(p=new h.ResponseSerializer,u.then(p.unWrapSaveSuccess.bind(p),p.unWrapSaveFailure.bind(p)))},formDataSave:function(t,n,r){var i=this,s=e.Object.size(n)>0,o=w(n),u=new e.Mail.Models.Serializers.DraftFormData(t),a=u.data(),f=S(t,n,o),l={options:{progress:function(e,t){m(n,t),g(f,t)},timeout:E(o)},upload:s,errHandler:L,suppressNotification:r&&r.suppressNotification,suppressStat:r&&r.suppressStat,logInfo:f},c;return c=i.transport.request(i.v3url,a,l),c},iframeSave:function(t,n,r){var i=this,s=w(n);return e.Object.each(n,function(e){e.setState("uploading")}),new Promise(function(o,u){e.use("io-upload-iframe",function(){var e=t.formId,a={},f={options:{form:
{id:e,upload:!0},timeout:E(s)},errHandler:L,suppressNotification:r&&r.suppressNotification,suppressStat:r&&r.suppressStat,logInfo:S(t,n,s)};i.transport.request(i.v3url,a,f).then(o,u)})})},sendBatch:function(e,t,n){var r=this,i={},o=e.mid,f={suppressNotification:!1,suppressStat:!1,doSend:!0,doSave:t,csid:e.csid,options:{timeout:s},errHandlerBatch:C},h,v,m,g,y,x;return t&&(f.logInfo=S(e)),typeof n=="undefined"&&(n=!0),n?(b(e,this.transport),h=p(e),v=d(e),x=w(h),f.options.timeout=E(x),t=f.doSave=f.doSave||h&&Object.keys(h).length>0,m=this.formDataSaveWithWebAttachments(e,h,v,f)):(g=this._createSendBatch(e,t),m=this.transport.requestBatchMultipart([g],f)),y=m.then(function(s){return i.errDetail=s.errDetail,r._wasMessageSent(s,t)&&e.setState("sent"),l?r._autoFixV2MidInGDM(s):r._convertToGDM(s),t&&r._processBatchAPIResponse(s,a,"save",i,function(t){r._handleSaveResponse(e,h,t.save)||(i.failure="save",i.errDetail=s[a].response.error||i.errDetail)}),r._processBatchAPIResponse(s,u,"send",i,function(){r._handleSendResponse(e)}),i.failure==="send"&&(i.errDetail=s[u].response.error),e.isInConv()?r._processBatchAPIResponse(s,c,"sendGDM",i,function(t){r._updateConvStore(e,t.sendGDM,o)||(i.failure="sendGDM",i.errDetail=s[c].response.error)}):r._updateMsgStore(e,o,i.save),i.failure?Promise.reject(i):i},function(t){return i.failure="batch",i.batch=t,i.errDetail=t.errDetail,Promise.reject(i)}),y},_autoFixV2MidInSaveResponse:function(e){if(!(NeoConfig.yodaReadEnabled&&e.messageV2&&e.message))return;e.messageV2.mid=e.message.id,e.messageV2.csid=e.message.csid},_convertToGDM:function(e){var t=e[c],n,r=function(e){return e&&e>199&&e<300};if(!t||!r(t.httpCode))return;n=t.response.result,t.response.result={message:[i.getDisplayMessage("simplebody",n)]}},_autoFixV2MidInGDM:function(e){var t=e[u],n=e[c],r,i,s=function(e){return e&&e>199&&e<300};if(!(NeoConfig.yodaReadEnabled&&t&&n&&s(t.httpCode)&&s(n.httpCode)))return;r=n.response.result.message[0],i=t.response.result.message,r.mid=i.id},_processBatchAPIResponse:function(e,t,n,r,i){var s=e[t],o=s&&s.response;if(r.failure)return;r[n]=o,s.success?i&&i(r):r.failure=n},_createSendBatch:function(t,n){var r=e.Mail.Core.Net.Helpers.BatchRequestHelper,i=e.Mail.Core.Net.Helpers.CascadeRequestHelper,s=new e.Mail.Models.Serializers.DraftPayloadPartSerializer(t),o={select:{mid:"$..message.immutableid"}},l={select:{mid:"$..message.id"}},h,p,d,v,m,g,y;return p=n?"$(mid)":encodeURIComponent(this._transformMidToRFC4648(t.mid)),h=this.v3url+"/@.id=="+p+"/send",t.generateCsid(),d={csid:t.csid},!n&&t.captchaAnswer&&(d.captcha=t.captchaAnswer),y=m=r.wrapCall(h,u,!0,d),n&&(y=v=r.wrapCall(this.v3url,a,!1,s.format()),r.attachChildCall(m,v,o)),t.isInConv()&&(f?g=r.createGSBRequest(c,"$(mid)","none"):g=r.wrapCall(i.getV2EndpointBatch(),c,!0,i.formatV2Payload(c,i.formatV2GdmParams("Sent","$(mid)","none"))),r.attachChildCall(g,m,l)),{name:"batchJson",contentType:"application/json",content:e.JSON.stringify({responseType:"json",requests:[y]})}},_handleSaveResponse:function(e,t,n){return N(e),this.gdmUnserializer.update(e,t,n),this.msgUnserializer.update(e,n),!this._updateDraftCaptcha(e,n)&&!e.isSpame()},_handleSendResponse:function(t){var n,r,i;try{n=t.makeInReplyTo(),n&&(n.forwarded||n.replied)&&(r=[t.origin.action==="edit"?n.messageReference.id:t.origin.oMsg],i=n.forwarded?{forwarded:1}:{replied:1},NeoConfig.yodaUpdateEnabled&&NeoConfig.yodaControllerLoaded?e.mail.controller.v3.api.flagMessagesWithMid({messages:r,sourceFid:t.origin.fid,flags:i,statTAE:!1}):e.mail.Controller.Messages.flag({fid:t.origin.fid,mid:r,setFlags:i},{suppressCodes:["*"]}))}catch(s){}},_updateConvStore:function(e,t,n){try{r.store({method:"send",draft:e,draftMid:n,msgResponse:t.result.message[0],midToCidResponse:[{cid:e.cid}]})}catch(i){return!1}return!0},_updateMsgStore:function(e,t,i){try{this._autoFixV2MidInSaveResponse(i.result),r.store({method:"send",draft:e,draftMid:t,msgResponse:n(i,"result.messageV2")})}catch(s){return!1}return!0},_updateDraftCaptcha:function(e,t){return e.captchaAnswer=null,t.result.message&&t.result.message.captcha?(e.captcha=t.result.message.captcha,!0):(e.captcha=null,!1)},_wasMessageSent:function(e,t){if(t)if(!e[a].success||n(e[a],"response.result.message.captcha")||n(e[a],"response.result.message.spame","U")==="N")return!1;return e[u].success?!0:!1},_transformMidToRFC4648:function(e){var t=e;return t=t.replace(/\+/g,"-"),t=t.replace(/\//g,"_"),t},_normalizeResponseObject:function(t){var r,i,s,o;if(typeof t=="string")try{r=e.JSON.parse(t)}catch(u){r={}}else r=t;return i=n(r,"result.simpleBody.attachments")||[],s=n(r,"result.messageV2.part")||[],o=n(r,"result.messageV2.mid")||"",i=i.filter(function(e){return e.included!=="N"}),{response:r,parts:s,attachments:i,mid:o}}}),e.namespace("Mail.Services").Compose=h},"1.0.0",{requires:["common-utils","json","json-parse","mail-core-net-policies-compose-policy","mail-core-net-transport","mail-models-serializers-draft-formdata-serializer","mail-models-serializers-draft-payloadpart-serializer","mail-core-net-helpers-batch-request-helper","mail-core-net-helpers-cascade-request-helper","mail-controller-conv-adapter","mail-models-serializers-draft-gdm-unserializer","mail-models-attachment-preprocessor","mail-controller-v3-converter","mail-models-serializers-draft-messageV3-unserializer","mail-controller-messages-ops","mail-services-response-serializer"]});
YUI.add("mail-compose-syncer",function(e){function i(e,t){n(e.folder.id.length>0,"Syncer requires draft.folder.id"),this.draft=e,this.service=t,this.dirty=!1,e.setState("saved")}var t=e.common.Utils,n=t.verify,r=t.getVal;i.prototype={save:function(r){var i=this,s=i.draft,o=Date.now(),u,a;if(s.state!=="unsaved")return;e.fire("stat:feature_invoke",{feature_group:"SAVE",message:"UI_SAVE_V3_START_SUCCESS"}),t.features.enabled("compose_save_adr")&&!t.features.enabled("composeActivityAdr")&&(t.features.enabled("delaySaveDraftAdRotation")?e.later(t.settings.value("saveDraftAdRotationDelay"),null,function(){e.fire("darlaEvent",{action:"compose_save"})}):e.fire("darlaEvent",{action:"compose_save"})),e.fire("SplunkLog","debug_draft",s.getSizeInfo(),"sample"),this.dirty=!1,s.setState("saving"),a=this.service.save(s,!1,r),a.then(function(r){n(!s.hasCsid()||s.csid===r.result.messageV2.csid,"csid invariant violated on svr response."),e.fire("stat:feature_complete",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE_SUCCESS"}),e.fire("stat:feature_latency",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE",value:Date.now()-o}),e.fire("persist:save"),u=s.state,r.result.messageV2&&(s.lastSavedRawBody=r.result.messageV2.part[0]);if(!i.dirty){s.setState("saved");return}s.setState("saved"),s.setState(u),n(s.state==="unsaved","state inconsistent w/dirty flag")},function(n){if(s.state==="sending"){e.fire("stat:feature_complete",{feature_group:"SAVE",message:"UI_SAVE_V3_CANCELED_SUCCESS"});return}e.fire("stat:feature_fail",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE_FAILURE",visible:!0,api:"messageSave"}),s.setState("unsaved",n.errDetail)})},_getErrorDetail:function(t){var n={message:"SavingAndSending: transport failed",code:"unknown"},i,s;try{i=r(t,"res.response");if(i)return n.message=e.JSON.parse(t.res.response).error.message,n.code=e.JSON.parse(t.res.response).error.code,n;i=r(t,"sendResponse.res");if(i)return s=e.JSON.parse(i.responseText),s=e.JSON.parse(s.error.message),n=s.error,n;i=r(t,"saveResponse.res");if(i)return s=e.JSON.parse(i.responseText),s=e.JSON.parse(s.error.message),n=s.error,n}catch(o){return n.message="SavingAndSending: unknown error",n}return n},send:function(n){function l(e){var n=NeoConfig.serverTime-NeoConfig.userRegTime<u,r={invoke:["ONBOARDING_SEND_INVOKED","ONBOARDING_CTRL_SEND_INVOKED","UI_SEND_V3_START_SUCCESS"],success:["ONBOARDING_SEND_SUCCESS","ONBOARDING_CTRL_SEND_SUCCESS","UI_SEND_V3_COMPLETE_SUCCESS"],failure:["ONBOARDING_SEND_FAILED","ONBOARDING_CTRL_SEND_FAILED","UI_SEND_V3_COMPLETE_FAILURE"],latency:["ONBOARDING_SEND_LATENCY","ONBOARDING_CTRL_SEND_LATENCY","UI_SEND_V3_COMPLETE"]};return n&&t.features.enabled("onboardingTest")?r[e][0]:n&&t.features.enabled("onboardingctrl")?r[e][1]:r[e][2]}function c(){i.setState("final"),e.fire("stat:feature_complete",{feature_group:"SEND",recipients:o,message:l("success")+(i.getAccountId()==="1"?"":"_EXTERNAL")}),e.fire("stat:feature_latency",{feature_group:"SEND",recipients:o,message:l("latency"),value:Date.now()-s}),e.fire("SentSuccess",null,null,a)}function h(t){var n=r._getErrorDetail(t);if(i.state==="savingAndSending"&&i.isRejectedOnCaptcha()){i.setState("captchaing");return}i.state==="sending"&&n.code==="EC-4011"&&(r.draft.captcha=null,r.draft.captchaAnswer=null),e.fire("stat:feature_fail",{feature_group:"SEND",message:l("failure")+(i.getAccountId()==="1"?"":"_EXTERNAL"),recipients:o,visible:!0,api:"messageSend"}),i.setState("unsaved",n)}function p(t){var n=t.errDetail;if(t.failure==="save"&&i.isRejectedOnCaptcha()){i.setState("captchaing");return}t.failure==="send"&&n.code==="EC-4011"&&(r.draft.captcha=null,r.draft.captchaAnswer=null);if(t.failure==="getCids"||t.failure==="sendGDM"){c(t);return}e.fire("stat:feature_fail",{feature_group:"SEND",message:"UI_SEND_V3_COMPLETE_FAILURE",recipients:o,visible:!0,api:"messageSend"}),i.setState("unsaved",n)}var r=this,i=r.draft,s=Date.now(),o=i.to.length,u=86400,a,f;o+=i.cc?i.cc.length:0,o+=i.bcc?i.bcc.length:0;if(i.state==="saving"||i.state==="sending"||i.state==="savingAndSending"||i.state==="sent"||i.state==="final")return;e.fire("stat:feature_invoke",{feature_group:"SEND",recipients:o,message:l("invoke")+(i.getAccountId()==="1"?"":"_EXTERNAL")}),e.fire("SentStart"),this.dirty=!1,i.state==="captchaing"||!i.hasAttachmentsToReconcile()&&i.state==="saved"&&i.hasCsid()?(i.setState("sending"),a="message_send",f=n?this.service.sendBatch(i,!1,i.hasPendingOrUploadingAttachments()):this.service.send(i)):(i.setState("savingAndSending"),a="message_sendSave",f=n?this.service.sendBatch(i,!0,i.hasPendingOrUploadingAttachments()):this.service.saveAndSend(i)),f.then(c,n?p:h)},edited:function(){this.draft.state!=="savingAndSending"&&this.draft.state!=="sending"&&this.draft.state!=="sent"&&this.draft.state!=="final"&&(this.dirty=!0,this.draft.setState("unsaved"))},unedited:function(){this.dirty=!1,this.draft.setState("saved")},isSaving:function(){return this.draft.state==="saving"},isEdited:function(){return this.draft.state==="unsaved"}},e.namespace("mail.Compose").Syncer=i},"1.0.0",{requires:["common-utils","mail-common-utils-features"]});
YUI.add("mail-model-spellcorrections",function(B){function A(){this.corrections=null;this.correctionsHash=null;this.publish("correctionsChanged");}B.mix(A.prototype,{setCorrections:function(C){this.corrections=C;this.fire("correctionsChanged");},setCorrectionsHash:function(C){this.correctionsHash=C;}});B.augment(A,B.EventTarget,true,null,{prefix:"spell"});B.namespace("mail.Model").SpellCorrections=A;},"1.0.0",{requires:["event-custom","oop"]});YUI.add("mail-controller-spell-processor",function(F){var C=F.common.Utils;var A={PREFIX:"spell",MIDPREFIX:"misspell-",MAX_SUGG:5,ERROR_404:"<html><head><title>Yahoo! - 404 Not Found</title><style>",MARK:"mark",MISPELLREG:null,MAX_SPELL_TEXT:51200};var B={},E={"str_rte_check_spelling":"NO_OP","str_rte_spell_lang_auto_select":"asl","str_rte_spell_lang_english_us":"en_US","str_rte_spell_lang_english_uk":"en_GB","str_rte_spell_lang_english_ca":"en_CA","str_rte_spell_lang_arabic":"ar","str_rte_spell_lang_bengali":"bn","str_rte_spell_lang_bulgarian":"bg","str_rte_spell_lang_croatian":"hr","str_rte_spell_lang_czech":"cs","str_rte_spell_lang_danish":"da","str_rte_spell_lang_dutch":"nl","str_rte_spell_lang_estonian":"et","str_rte_spell_lang_filipino":"tl","str_rte_spell_lang_finnish":"fi","str_rte_spell_lang_french_canada":"fr_CA","str_rte_spell_lang_french_france":"fr_FR","str_rte_spell_lang_french_switzerland":"fr_CH","str_rte_spell_lang_german_austria":"de_AT","str_rte_spell_lang_german_switzerland":"de_CH","str_rte_spell_lang_german_germany":"de_DE","str_rte_spell_lang_greek":"el","str_rte_spell_lang_gujarati":"gu","str_rte_spell_lang_hebrew":"he","str_rte_spell_lang_hindi":"hi","str_rte_spell_lang_hungarian":"hu","str_rte_spell_lang_indonesian":"id","str_rte_spell_lang_italian":"it","str_rte_spell_lang_kannada":"kn","str_rte_spell_lang_latvian":"lv","str_rte_spell_lang_lithuanian":"lt","str_rte_spell_lang_malay":"ms","str_rte_spell_lang_malayalam":"ml","str_rte_spell_lang_marathi":"mr","str_rte_spell_lang_norwegian_bokmal":"nb","str_rte_spell_lang_norwegian_nynorsk":"nn","str_rte_spell_lang_polish":"pl","str_rte_spell_lang_portuguese_brazil":"pt_BR","str_rte_spell_lang_portuguese_portugal":"pt_PT","str_rte_spell_lang_romanian":"ro","str_rte_spell_lang_russian":"ru","str_rte_spell_lang_serbian":"sr-cyrl","str_rte_spell_lang_slovak":"sk","str_rte_spell_lang_slovenian":"sl","str_rte_spell_lang_spanish":"es","str_rte_spell_lang_swedish":"sv","str_rte_spell_lang_tamil":"ta","str_rte_spell_lang_telugu":"te","str_rte_spell_lang_turkish":"tr","str_rte_spell_lang_ukrainian":"uk","str_rte_spell_lang_vietnamese":"vi"};var D={"en-US":"en_US","en-GB":"en_GB","en-CA":"en_CA","en-JO":"en_US","en-IN":"en_GB","ko-KR":"en_GB","en-SG":"en_GB","zh-Hant-TW":"en_GB","zh-Hant-HK":"en_GB","en-AU":"en_GB","en-NZ":"en_GB","en-MY":"en_GB","en-IE":"en_GB","en-PH":"en_GB","zh-CN":"en_GB","en-XC":"en_GB","en-035":"en_GB","th-TH":"en_GB","es-CL":"en_GB","es-US":"es","es-AR":"es","es-PE":"es","es-VE":"es","es-CO":"es","es-MX":"es","ar-JO":"ar","bn-BD":"bn","bg-BG":"bg","hr-HR":"hr","cs-CZ":"cs","da-DK":"da","nl-BE":"nl","nl-NL":"nl","et-EE":"et","tl-PH":"tl","fi-FI":"fi","fil-PH":"tl","fr-BE":"fr_FR","fr-CA":"fr_CA","fr-FR":"fr_FR","fr-CH":"fr_CH","de-AT":"de_AT","de-CH":"de_CH","de-DE":"de_DE","el-GR":"el","gu-IN":"gu","he-IL":"he","hi-IN":"hi","hu-HU":"hu","id-ID":"id","it-IT":"it","kn-IN":"kn","lv-LV":"lv","lt-LT":"lt","ms-MY":"ms","ml-IN":"ml","mr-IN":"mr","nb-NO":"nb","nn-NO":"nn","pl-PL":"pl","pt-BR":"pt_BR","pt-PT":"pt_PT","ro-RO":"ro","ru-RU":"ru","sr-Cyrl-RS":"sr-cyrl","sk-SK":"sk","sl-SI":"sl","es-ES":"es","sv-SE":"sv","ta-IN":"ta","te-IN":"te","tr-TR":"tr","uk-UA":"uk","vi-VN":"vi"};function G(){this.spellHelper=A;}F.mix(G.prototype,{checkSpelling:function(N,K,M,H,I){var O=this,T=this.getLangSymbol(H);if(T==="NO_OP"){return;}if(T===""||T==="asl"){T=false;}if(T==="fr_CA"){T="fr_FR";}var L=function(W){var V=(W)?F.JSON.parse(W.responseText):null;O._saveMisspelledWords(N,V);};var S={success:function(W){var V=(W)?F.JSON.parse(W.responseText):null;O._saveMisspelledWords(N,V);},failure:function(){},responseType:"text",args:{}};S.success=(I)?I:L;var Q=K.replace(/%/g,"%25");if(Q&&Q.length>A.MAX_SPELL_TEXT){Q=Q.substring(0,A.MAX_SPELL_TEXT);}if(Q.match(/<var.*yui-ie-cursor.*var>/g)){Q=Q.replace(/<var.*yui-ie-cursor.*var>/g,"");}var J={};J.text=Q;J.iformat="html";J.oformat="js";J.intl=M;J.lang=T;var P=NeoConfig.launch_protocol+document.location.host;var R=P+"/ysp.php";var U=F.common.net.SessionMgr.request(R,F.common.net.SessionMgr.formatQueryParams(J),S,"POST");U.setHeader("Content-Type","application/x-www-form-urlencoded");U.setHeader("Connection","close");U.send();},markMisspelledWords:function(N,H,Q){var O="";if(H&&H.length){var K=H.length;var J=0;var R="";var I=null,P=null;var L=0;for(var M=0;M<K;++M){L=parseInt(H[M].offset,10);I=H[M].word;if(this._isWordIgnored(I,Q)){continue;}O+=N.substring(J,L);P=N.substring(L,L+I.length);if(I===P){O+=this._getMarkerHtml(A.MIDPREFIX+M,P);}else{O+=P;R+=I+"="+P+"|";}J=L+I.length;}if(R){}O+=N.substr(J,N.length);}return O;},_saveMisspelledWords:function(I,H){var K={};if(H&&H.length){var M=H.length;for(var J=0;J<M;++J){var L=H[J].word;K[L]=H[J];}}I.setCorrectionsHash(K);I.setCorrections(H);},removeAllMarkers:function(I,J){var H=(J&&J.toUpperCase)?J.toUpperCase():"";I.all("span[class='"+A.MARK+"']").each(function(L){if(L.get("id").indexOf(A.MIDPREFIX)!==-1){var K=L.get("text").toUpperCase();if(H!==""&&H!==K){return;}I.insert(L.get("innerHTML"),L);L.purge();L.remove();}});},removeMarker:function(I,H){var J=H.get("innerHTML");this.updateMarker(I,H,J);},updateMarker:function(K,H,J){if(J){var I=H.cloneNode(true);I.set("innerHTML",J);I.removeClass(A.MARK);H.purge();H.replace(I);}else{H.purge();H.remove();}},_getMarkerHtml:function(H,I){var J=[];J.push('<span id="');J.push(H);J.push('" class="');J.push(A.MARK);J.push('">');J.push(I);J.push("</span>");return J.join("");},getLangSymbol:function(K){var H="",J,I;if(C.isEmpty(B)){for(I in E){J=strings[I];if(J){B[J]=E[I];}}}if(K){H=B[K];}else{H=D[NeoConfig.lang];}return(H)?H:"";},_getHeaderIgnoredWord:function(K){var I="";if(K){var J=0,H=K.length,L;for(J=0;J<H;J++){L=K[J];I+=L.name+" "+L.email+" ";}}return I;},gatherIgnoreWords:function(O,N){var L="";O.all("img").each(function(P){if(P.hasAttribute("alt")){var Q=P.get("alt");L+=Q+" ";}});if(N.currentAddress){L+=N.currentAddress+" ";}L+=this._getHeaderIgnoredWord(N.from);L+=this._getHeaderIgnoredWord(N.to);
L+=this._getHeaderIgnoredWord(N.cc);L+=this._getHeaderIgnoredWord(N.bcc);var H=F.common.persist.UserData;var K=H.get("userSendPref.defaultFromAddress")||"",J=H.get("userSendPref.defaultFromName")||"",I=H.get("userSendPref.defaultID")||"",M=H.get("userSendPref.loggedInAlias")||"";L+=K+" "+J+" "+I+" "+M+" ";L=L.toUpperCase();L=L.replace(/[\x21-\x40\x5B-\x60\x7B-\x7E]/g," ");L=L.replace(/([^;])[-_\s]+/g,"$1|");return L?L.split("|"):[];},_isWordIgnored:function(J,I){if(I.length===0){return false;}J=J.toUpperCase();var H=F.Array.indexOf(I,J);return(H!==-1);}});F.namespace("mail.Controller").SpellProcessor=new G();},"1.0.0",{requires:["mail-model-spellcorrections","common-net-sessionmgr","common-persist-user-data","json-parse"]});YUI.add("_shared_module_offscreen_bin_modal_cloud_filepermissions",function(e){e.namespace("ui.Templates"),e.ui.Templates._shared_module_offscreen_bin_modal_cloud_filepermissions={base:'<div id="modal-cloud-permissions" class="modal"> <h2 class="modal-hd"> {{modal_header}} {{_shared_module_offscreen_bin_modal_close_icon}} </h2> <div class="modal-bd"> {{modal_body}} </div> <div class="modal-ft"> {{modal_ft}} </div> <div class="modal-subft"><input type="checkbox" class="dontshow">{{str_donotshow_again_msg}}</div></div>'}},"1.0.0",{requires:["_shared_module_offscreen_bin_modal_close_icon"]});
YUI.add("mail-controller-cloud-linkutil",function(e){"use strict";var t=e.common.Utils,n=t.features,r=null,i=t.getBootcampURL(),s="mailcompose",o="neo.pref.cloud.showFilePermsDlg",u=e.mail.persist.MetaData,a;a=function(){function f(){var e=require("BootcampAPIUtilsV2");r||(r=new e({bucketId:NeoConfig.expBucketId,wssid:NeoConfig.wssid,mailboxId:NeoConfig.V3MailboxId,isForceUser:NeoConfig.forceDS,hasMultipleAccounts:NeoConfig.multipleAccounts,searchResultsLinksEnabled:!1,lmv3Enabled:n.enabled("LMV3"),clientId:s,bcHost:i}))}function l(t){var n;return f(),n=r.getShareableLink(t).then(function(t){e.fire("util:ymstats",{name:"cloud_shareablelink_success"});if(t.data)return t.data.shareableLink;return},function(n){throw e.fire("util:ymstats",{name:"cloud_shareablelink_fail"}),e.fire("SplunkLog","debug_shareablelink",{response:n,param:t},NeoConfig.isCorpmail?"critical":"info"),n}),n}function c(e){return{cardInfo:{url:e.shareableLink||e.downloadLink,title:e.name,type:"article",image:{},description:e.description},urlDomain:e.urlDomain}}function h(e,t){var n;l(t).then(function(r){r?(t.shareableLink=r,n=c(t),e.fire("cardify",[n],t.source)):p({type:"error",data:t,cbk:function(){h(e,t)}})})}function p(n){var r=strings.str_cloud_shareablelink_failed;r=r.replace(/\{\{provider_title\}\}/g,t.escapeHtml(n.data.providerTitle)),r=r.replace(/\{\{filename\}\}/g,t.escapeHtml(n.data.name)),r+=' <a data-action="link">'+strings.str_try_again+"</a>",e.common.ui.NotificationV2.notify(r,{type:n.type,duration:4e3,speed:"show-fast",cbk:function(e,t){t==="link"&&n.cbk&&n.cbk()}})}function d(t,n){e.common.ui.DialogHelper.confirm({hd:strings.str_file_perms_changed,bd:strings.str_file_perms_changed_desc.replace(/\{\{provider_title\}\}/g,n.providerTitle),rawTemplate:e.ui.Templates._shared_module_offscreen_bin_modal_cloud_filepermissions.base,suppressRestoreFocus:!0,str_donotshow_again_msg:strings.str_donotshow_again_msg},{ok:{stopDestroy:!0,handler:function(e,r){var i;r&&(i=r.get("contentBox"),i.one(".dontshow").get("checked")&&u.set(o,"0"),r.destroy()),h(t,n)}},cancel:{handler:function(){}}})}function v(e,t){u.get(o)?h(e,t):d(e,t)}var a=this;e.mix(a,{handleInsertCloudLink:v},!0)},e.namespace("mail.Controller").cloudLinkUtil=new a},"1.0.0",{requires:["tictac-lib","common-ui-notification-v2","_shared_module_offscreen_bin_modal_cloud_filepermissions","common-ui-dialog-helper","mail-persist-meta-data","common-utils"]});
YUI.add("mail-controller-composecontent-helper",function(e){function r(e){this.ctrl=e,this.pendingInsertedItems={},this.bindComposeEvent()}var t=3e4,n=e.mail.Controller.cloudLinkUtil;e.mix(r.prototype,{buildDomId:function(e){return"contentHelper_"+e},bindComposeEvent:function(){var e=this,t=e.ctrl.view;t.once("closeChange",e.destroy,e)},resolvePendingContent:function(e){var t=this,n,r;if(Object.keys(t.pendingInsertedItems).length>0)for(r in t.pendingInsertedItems)n=t.pendingInsertedItems[r],n.processOnNodeCallBack({htmlNode:e});return e},attachFromBlob:function(t,n){var r=new e.mail.Models.Attachment(null,{file:t.blob,filename:t.name,size:n,disposition:"attachment"});this.ctrl.draft.addAttachment(r),this.ctrl.draft.setState("unsaved"),this.ctrl.save()},attachFromMessageData:function(t,n){var r=t.mid,i=t.partId*1,s=t.name,o=t.thumbnailurl||t.thumbnail,u;if(!(e.Lang.isNumber(i)&&e.Lang.isString(s)&&e.Lang.isString(r)&&e.Lang.isString(o)))return;u=new e.mail.Models.Attachment(r,{mid:r,partId:i,filename:s,size:n,thumbnailurl:o,currentSessionAttachment:!0}),u.setState("uploaded"),this.ctrl.draft.addAttachment(u),this.ctrl.draft.setState("unsaved"),this.ctrl.save()},handleAttachment:function(e){var t=this;if(t.ctrl.willAttachmentOverflow(e.length))return;switch(e.type){case"attachment":t.attachFromMessageData(e.data,e.length);break;case"blob":t.attachFromBlob(e.data,e.length)}},processUneditableInsertion:function(e){var t="<p><br></p>",n=/\bcontenteditable\s*?=\s*?["']?false["']?\b/i.test(e);return n,e.length>20&&n&&(e=t+e+t),e},getInsertCompleteFunc:function(t){var n=this;return function(r){var i=r&&r.markup||t.markup,s=t.timerId,o=!1,u,a,f,l,c;t.processOnNode?f=r.htmlNode:(a=n.ctrl.view,l=a&&a.editor&&a.getRTE().rte,f=e.one(l&&l.element)),f&&(u=f.one("#"+n.buildDomId(t.markupId))),u&&u.getDOMNode()&&(i?(u.replace(i),o=!0):u.remove()),t.processOnNode||(o?e.fire("contentHelper:"+t.markupId+":insertionSuccess"):e.fire("contentHelper:"+t.markupId+":insertionFail"),s&&clearTimeout(s),c=n.pendingInsertedItems[t.markupId],c&&(c.resolveEventHandler.detach(),c.rejectEventHandler.detach(),delete n.pendingInsertedItems[t.markupId]))}},handleInsertText:function(n){var r=this,i=this.ctrl.view,s=n.data,o=i.getRTE().rte,u=o.getPluginByName("rte-caret-plugin"),a,f,l,c,h,p,d,v,m,g,y,b;o.setCaret();switch(n.type){case"plain":o.insertText(s);break;case"html":o.isRich&&(u.restoreCaret(),s=r.processUneditableInsertion(s),o.pushButton("insertHtml",s),u.scrollCaretIntoView());break;case"promisehtml":o.isRich&&(u.restoreCaret(),f=s.markupId,c='<div id="'+r.buildDomId(f)+'">'+s.updatingMarkup+"</div>",c=r.processUneditableInsertion(c),o.pushButton("insertHtml",c),u.scrollCaretIntoView(),p={markupId:f,markup:s.resolveMarkup},h={markupId:f,markup:s.rejectMarkup},d={markupId:f,markup:s.resolveMarkup,processOnNode:!0},m=r.getInsertCompleteFunc(p),v=r.getInsertCompleteFunc(h),g=r.getInsertCompleteFunc(d),a=setTimeout(m,t),p.timerId=a,h.timerId=a,d.timerId=a,l="contentHelper:"+f,b=e.once(l+":resolve",m),y=e.once(l+":reject",v),r.pendingInsertedItems[f]={timerId:a,processOnNodeCallBack:g,resolveEventHandler:b,rejectEventHandler:y});break;default:throw"unknow dataTransfer content type "+n.type}r.ctrl.draft.setState("unsaved"),r.ctrl.save()},handleInsertCloudLink:function(e){var t=this,r=t.ctrl.view,i=e.data,s=r.getRTE();s.rte.isRich&&n.handleInsertCloudLink(s,i)},handleDataTransfer:function(e){var t=this,n=e.payload,r=n&&n.content;if(!(n&&n.action&&r&&r.type&&r.data&&r.length>=0))return;switch(n.action){case"attach":t.handleAttachment(n.content);break;case"insertText":t.handleInsertText(n.content);break;case"insertCloudLink":t.handleInsertCloudLink(n.content);break;default:throw"unknow dataTransfer action"+n.action}t.ctrl.attachedUsingComposeAssist=e.payload.source==="compose_assist",t.ctrl.lastCAContentProvider=e.payload.contentProvider},destroy:function(){var e=this,t,n;for(n in e.pendingInsertedItems)t=e.pendingInsertedItems[n],t.resolveEventHandler.detach(),t.rejectEventHandler.detach(),clearTimeout(t.timerId)}}),e.namespace("mail.Controller").ComposeContentHelper=r},"1.0.0",{requires:["mail-model-attachment","mail-controller-cloud-linkutil"]});
YUI.add("mail-controller-inlineimage-processor",function(e){function t(){}function n(e){var t;return e.attachments?(t=e.attachments.reduce(function(e,t){return e+t.size()},0),t):0}function r(e){e&&e.attachments&&e.attachments.filter(function(e){return(e.state()==="failed"||e.state()==="infected")&&e.isInline()&&e.setState("deleted"),!0})}function i(t){var n=t.inlineImageNode,r=t.ctrl,i=t.lastExitCode,s=t.imageList,o=t.attachmentList,u=n.getAttribute("data-id"),a=s.get(u),f,l="",c,h;if(0!==i)return 1;if(!a)return 1;t.rteImagePlugin.setDraftModel(r.draft),f=a.get("attachment"),f&&f.state()!=="pending"&&(f.setState("deleted"),f=null);if(!f){h=a.processedFile.size;if(r.isOverMaxFileSize(t.existingAttachmentSize+h))return r.view.showAttachmentSizeDialog("25"),r.draft.fire("attachmentSizeOverflow"),t.node.all(".rte-inline-unsaved-image").remove(),1;t.existingAttachmentSize=t.existingAttachmentSize+h,f=new e.mail.Models.Attachment(null,{file:a.processedFile,filename:a.file.name,size:h,disposition:"inline",fetchFromWeb:a.isFromSrc,webUrl:a.webUrl,currentSessionAttachment:!0}),o.push(f),r.draft.addAttachment(f),a.set("attachment",f)}return c=f.contentId().match(/\<(.+)\>/),c&&(l=c[1]),n.setAttribute("src","cid://"+l),n.addClass("rte-inline-saved-image"),n.addClass(u),0}e.mix(t.prototype,{process:function(e,t){var s=e.getRteImagePlugin(),o,u;if(!s)return t;u={ctrl:e,lastExitCode:0,existingAttachmentSize:n(e.draft),attachmentList:[],imageList:s.imageList,node:t,rteImagePlugin:s},t.all(".rte-inline-unsaved-image").each(function(e){u.inlineImageNode=e,u.lastExitCode=i(u)}),t.all(".rte-inline-unsaved-image").removeClass("rte-inline-unsaved-image");if(1===u.lastExitCode)for(o=0;o<u.attachmentList.length;o++)u.attachmentList[o].setState("deleted");return r(e.draft),t}}),e.namespace("mail.Controller").InlineImageProcessor=new t},"1.0.0",{requires:["mail-common-utils-features"]});
YUI.add("mail-controller-compose-v3",function(e){function S(){var t=h.getVal(this,"view.editor.rte.element");if(!t)return;e.one(t).all("img").each(function(t){var n=t.getAttribute("data-id");n||t.setAttribute("data-id",e.common.Utils.guid())})}function x(e){var t=this;t.injectDataIdFromImages(),t.setDraftHeader(),t.setDraftBody(),t.syncer.save({suppressNotification:!!e,suppressStat:!!e})}function T(){var e=this;this.setDraftHeader(),this.setDraftBody({isSend:!0}),e._validateSend().then(function(){e.attachOnSend&&(e.draft.setState("unsaved"),e.attachOnSend=!1),e.syncer.send(!0),e._fireSendStats.bind(e)()})["catch"](function(){e.cancelHideCompose()})}function N(){var t=this,n,r=t._getAttachmentStatInfo();t.draft.attachments&&t.draft.attachments.length&&(n=t.view.get("isQuickReply"),p.enabled("richcompose")&&e.fire("util:ymstats",{name:"compose_assist_att_send",tags:{caUsed:t.attachedUsingComposeAssist?1:0,type:n?"QR":"fullCmps"},include:{bucket:!0}}),e.fire("mt:click",{action:"tlbr_att_send",append:{ltxt:t.attachedUsingComposeAssist?"ca":"noca",cmpsType:n?"QR":"fullCmps"}})),e.fire("util:ymstats",{name:"compose_send_info",tags:{type:t._getMessageType(),attFilesCount:r.attFilesCount,attImagesCount:r.attImagesCount,inlineImagesCount:r.inlineImagesCount,caUsed:t.lastCAContentProvider||""},include:{bucket:!0}})}function C(){var e="newCompose",t;return t=this.draft.makeInReplyTo(),t&&(t.replied?e="reply":t.forwarded&&(e="forward")),e}function k(e){if(e<3)return""+e;if(e<=10)return"3to10";if(e>10)return"gt10"}function L(){var e=this,t=e.draft.getUploadedOrSavedAtt(),n=0,r=0,i=0,s;return t&&t.length&&t.forEach(function(e){s=e.state();if(!e.isCurrentSessionAttachment())return;e.isInline()?i+=1:e.isImage()?r+=1:n+=1}),{attFilesCount:k(n),attImagesCount:k(r),inlineImagesCount:k(i)}}function A(){var t=this,n=this.view.sendValidationHandlers,r=e.mail.Models.Validators.send,i=[],s={},o,u;if(!b){u=r.validateNotUploadingAttachments(t.draft);if(!u.valid)return n.handleUploadInProgress(),Promise.reject()}u=r.validateCleanAttachments(t.draft);if(!u.valid)return n.handleBadAttachments(u.cntInfected),t.view.tray.showError(),Promise.reject();u=r.validateAddress(t.draft);if(!u.valid)return n.handleAddressInvalid(u.invalidAddress),Promise.reject();u=r.validatePresenceOfRecipients(t.draft);if(!u.valid)return n.handleNoRecipients(),Promise.reject();u=r.validateNumberOfRecipients(t.draft);if(!u.valid)return n.handleTooManyRecipients(),Promise.reject();u=r.validateSpame(t.draft);if(!u.valid)return n.handleSpame(),Promise.reject();u=r.validatePresenceOfContent(t.draft),u.valid||i.push(new Promise(function(e,t){n.handleEmptyMessage(e,t)})),u=r.validateCaptcha(t.draft),u.valid||i.push(new Promise(function(e,r){n.handleCaptcha(e,r,t.draft)})),p.enabled("attachInReply")&&t.attachInReply&&(u=r.checkForAttachment(t.draft),u.valid||i.push(new Promise(function(e,r){n.handleNewRecipients(e,r,t)})));if("saving"===t.draft.state||b&&t.draft.isUploadingAttachments())b&&("unsaved"===t.draft.state&&t.save(),t.draft.isUploadingInlineImages()===!0?(t.attachOnSend=!0,s={isInlineImage:!0}):t.draft.isUploadingAttachments()===!0&&(t.attachOnSend=!0,s={isAttachment:!0})),o=function(e){var n;b?t.scheduleHideCompose(s):t.view.showComposeShim(!0),n=t.draft.on("stateChanged",function(r){r.next==="saved"&&setTimeout(function(){t.setDraftBody({isSend:!0}),n.detach(),e()},1)})},i.push(new Promise(o));return Promise.all(i)}function O(){this.syncer.edited()}function M(){this.syncer.unedited()}function _(){return this.syncer.isSaving()}function D(){return this.syncer.isEdited()}function P(){return this.prePopulated}function H(e){var t=this.view.getFontInfo(),n=this.view.getRTEDocNode(),r,i=h.getVal(this.draft.origin,"yqtdPrefix"),s="",f="",l=!!e&&e.isSend,p=this.draft.needsOutlookSupport,d=this.composeContentHelper;this.view._isSpellCheckActive()&&c.removeAllMarkers(n,null),this.view._isRTEActive()?(r=u.processDocNode(this.view.getContentNodeClone(),i),d&&(r=d.resolvePendingContent(r)),l||(r=a.process(this,r)),s=r.getHTML(),s=u.processRawHTML(s),s=u.wrap(s,t,p)):f=o.process(n),this.view.updateUploadForm&&(window.FormData===undefined||window.FileReader===undefined)&&this.view.updateUploadForm(),this.draft.setBody(f,s),this.view.dirty&&this.draft.setSpame("U")}function B(){var t=this.view.getHeader(),n=e.mail.Controller.mailComposeFromListHelper.getReplyTo;t.replyto={email:n(t.from.email),name:t.from.name},this.draft.setHeader(t)}function j(){this.edited(),this.save()}function F(){this.view.on("FullCompose:composeEvent",this.handleEvent,this)}function I(){var e,t;this.parent&&(e=this.parent.all(".compose-loading-wrapper"),e&&e.remove(),this.view.render(this.parent),this.composeViewTainer=this.view.baseNode),this.view.on("attachmentUpload",this.handleFileUpload,this),this.view.on("dataTransfer",this.composeContentHelper.handleDataTransfer,this.composeContentHelper),this.view.on("attachmentUploadForm",this.handleFileUploadForm,this),this.draft.on("stateChanged",this.handleStateChange,this),this.view.neoFire("composeEvent",{action:"bindComplete",ccv:this}),t=this.getRteImagePlugin(),t&&(t.setDraftModel(this.draft),t.on("inline-image-updated",this.handleInlineImageAdded,this))}function q(e){var t,n,r=p.enabled("ccOnSend"),i="",s;p.enabled("isMetaDataMigrated")||NeoConfig.forceToV3UserSetting?(g.getSync("attributes.web.ccOnSend",!1)&&(i="cc"),g.getSync("attributes.web.bccOnSend",!1)&&(i=i===""?"bcc":"both")):i=v.get("ccOnSend");if(r){s=f.getDefaultFromAddress(e.getAccountId());if(i==="cc"||i==="both"){e.cc||(e.cc=[]),n=!1;for(t=0;!n&&t<e.cc.length;t++)e.cc[t].email===s.email&&(n=!0);n||e.cc.push(s)}if(i==="bcc"||i==="both"){e.bcc||(e.bcc=[]),n=!1;for(t=0;!n&&t<e.bcc.length;t++)e.bcc[t].email===s.email&&(n=!0);n||e.bcc.push(s)}}}function R(t,n){var r=this,i=t&&t.fid,s=new e.Mail.Models.Draft,o=t&&t.flavor==="autocompose",u;return r.setDraftOrigin(s,t),u=s.folder,u.id=w(i),u.acctId=i&&e.mail.ui.FolderUtils.getAcctIdByFid(i),NeoConfig.imapIn&&!u.acctId&&(u.acctId=
e.mail.Controller.ImapIn.getCurrentAccountId()),NeoConfig.am&&!u.acctId&&(u.acctId=e.mail.ui.FolderUtils.PrimaryAcctId),n||r.setMessageFromAddress(s),t&&t.cbfn&&(this.prePopulated=t.cbfn(s,t)),!n&&!o&&l.insertSignature(s,m.get("userUIPref.useRichText")),n||r._setAutoCC(s),s}function U(e){var t=this,n=e.action;t.eventHandlers&&t.eventHandlers[n]&&t.eventHandlers[n](e)}function z(e){var t=new FileReader;return new Promise(function(n){t.onload=function(t){e.realSize=t.total,n()},t.onerror=function(){e.realSize=0,n()},t.readAsArrayBuffer(e)})}function W(t,n,r){var i=this,s=n.reduce(function(e,t){return e+t.size()},0),o=[],u=0;e.Array.each(t,function(e){o.push(i._findRealFileSize(e))}),Promise.all(o).then(function(){u=t.reduce(function(e,t){return e+t.realSize},0),typeof r=="function"&&r(s,u)})}function X(n){var i=this,s=this.draft.attachments,o=Promise.resolve();return i._determineSize(n.files,s,function(o,u){var a=n.files.filter(function(e){return e.realSize===0});if(a.length>0){i.view.showAttachmentEmptyDialog(a);return}i.isOverMaxFileSize(o+u)?i.view.showAttachmentSizeDialog(t):s.length+n.files.length>r?i.view.showAttachmentCountDialog(r):(e.Array.each(n.files,function(t){i.draft.addAttachment(new e.mail.Models.Attachment(null,{file:t,filename:t.name,size:t.realSize,currentSessionAttachment:!0}))}),i.edited(),i.save())}),o}function V(t){var n=this,i=t.inputEl,s=i.value||"",o=s.substr(s.lastIndexOf("\\")+1);n.draft.attachments.length+1>r?n.view.showAttachmentCountDialog(r):(n.draft.addAttachment(new e.mail.Models.Attachment(null,{inputEl:i,filename:o,size:1})),n.edited(),n.save())}function $(e){var n=this,i=n.draft.attachments,s=t+"",o=i.reduce(function(e,t){return e+t.size()},0);return n.isOverMaxFileSize(o+e)?(n.view.showAttachmentSizeDialog(s),!0):i.length+1>r?(n.view.showAttachmentCountDialog(r),!0):!1}function J(e){var t=this;e.next==="sent"?(t.view.dirty=!1,t.eventHandlers.closeAction(e)):!b||e.next!=="sending"&&e.next!=="savingAndSending"?e.next==="final"?t.autoAddContacts(t.draft):e.next==="captchaing"&&(t.captchaRetryCount>=i?(t.captchaRetryCount=0,t.draft.setState("unsaved",{code:"EP-4010"})):(t.captchaRetryCount++,t._validateSend().then(function(){t.syncer.send(!0)})["catch"](function(){t.draft.setState("saved"),t.cancelHideCompose()}))):t.scheduleHideCompose()}function K(e){var t=this,n=d&&d.value("showSendingDelay"),r=t.view.get("isQuickReply"),i={};if(!t.eventHandlers.hideAction)return;if(t.view.cancelShowComposeNotification===!0){t.view.cancelShowComposeNotification=!1;return}n&&n>0?t.timers.push(setTimeout(t._showComposeNotification.bind(this,e),n)):t._showComposeNotification(e),t.view.dirty=!1,r&&(i={from:t.draft.from,hasTO:t.draft.to.length>0,hasCC:t.draft.cc.length>0,hasBCC:t.draft.bcc.length>0}),t.eventHandlers.hideAction(i)}function Q(t){var n=this,r=n.draft.state,i=n.view,s=t&&t.isAttachment,o=t&&t.isInlineImage,u=r==="sending"||r==="savingAndSending",a={type:"info",speed:"show-medium"},f,l,c;if(n.view.cancelShowComposeNotification===!0){n.view.cancelShowComposeNotification=!1;return}o&&!u?(f=strings.str_comp_inline_image_attach_progress,c="InlineAttaching"):s&&!u?(f=strings.str_comp_attach_upload_progress,c="Attaching"):(f=strings.str_comp_sending,c="Sending"),l='<span class="s-loader"></span><span class="message compose-notification">'+f+"</span>",e.fire("util:ymstats",{name:"compose_sending_notification",tags:{agent:NeoConfig.browser,isCorp:NeoConfig.isCorpmail?1:0,action:c,show:!0}});if(!u&&!s&&!o){r==="final"&&e.fire("util:ymstats",{name:"compose_sending_notification",tags:{agent:NeoConfig.browser,isCorp:NeoConfig.isCorpmail?1:0,action:"Sent",show:!1}});return}e.use("common-ui-notification-v2",function(e){var t=e.common.ui.NotificationV2;n._isComposeNotification()?i.lastNotification=t.update(l,a):i.lastNotification=t.notify(l,a)})}function G(){var e=this,t=e.view,n=t.lastNotification&&t.lastNotification.container;return n&&n.one(".compose-notification")?!0:!1}function Y(){var t=this;!NeoConfig.isAMT&&m.get("userSendPref.addUnknownContact")!=="prompt"&&e.use("mail-controller-contact-processor",function(e){e.mail.Controller.ContactProcessor.addContacts(t.draft)})}function Z(e){var t=e.header||{},n=e.getAccountId();t.from=f.getDefaultFromAddress(n),e.setHeader(t)}function et(e,t){t&&t.action&&t.fid&&t.oMsg&&e.setOrigin({action:t.action,fid:t.fid,oMsg:t.oMsg,parentMsg:t.parentMsg,forwardAsAttachment:t.forwardAsAttachment,ctxReq:null})}function tt(e){this.parent=e}function nt(e){var t=this;t.view.isSending=!1,t.view.resetSaveTimer(),e&&(t.view.dirty=!0,t.view.allowSend=!0),t.composeActive=!0}function rt(){var e=h.getVal(this,"view.editor.rte.plugins"),t=0;if(!e)return null;for(t=0;t<e.length;t++)if(e[t].name==="inline-image-plugin")return e[t];return null}function it(e){return e>n}function st(){var e=this,t=e.timers,n=0,r=t&&t.length;if(!r||r<1)return;for(n=0;n<r;n++)clearTimeout(t[n]);e.timers=[]}function ot(){var e=this;e._destroyTimers()}function ut(e){var t=this,n=d&&d.value("closeComposeDelay");t.view.cancelShowComposeNotification=!1,n&&n>0?(t._unsetHideComposeTimer(),t.hideComposeTimer=setTimeout(function(){t._hideComposeTab(e)},n),t.timers.push(t.hideComposeTimer)):t._hideComposeTab(e)}function at(){var e=this;e.hideComposeTimer||(clearTimeout(e.hideComposeTimer),e.hideComposeTimer=undefined)}function ft(){var e=this;setTimeout(function(){e.view.cancelShowComposeNotification=!0,e._destroyTimers(),e.view.lastNotification&&e.view.lastNotification.clearAll(),e.view.set("viewable",!0),e.view.neoFire("composeEvent",{action:"showAction"})},1)}var t=25,n=t*1024*1024,r=50,i=2,s=e.common,o=e.mail.Controller.TextProcessor,u=e.mail.Controller.HtmlProcessor,a=e.mail.Controller.InlineImageProcessor,f=e.mail.Controller.ReplyProcessor,l=e.mail.Controller.SignatureProcessor,c=e.mail.Controller.SpellProcessor,h=s.Utils,p=h.features,d=h.settings,v=e.mail.persist.MetaData,m=s.persist.UserData,g=e.mail.controller.v3.settings.userSettings,y=e.mail.ui.FolderUtils,b=p.enabled("instantCloseOnSend"
),w=function(t){var n,r,i,s;return NeoConfig.imapIn?(s=e.mail.ui.FolderUtils,i=e.mail.Controller.ImapIn,r=s.get(t).acctId||i.getCurrentAccountId(),n=""+i.getFolderByType(s.DraftFolderType,r).folderInfo.index):n=""+y.getFolderByName("Draft").folderInfo.index,n},E=function(t,n,r,i,s){this.parent=t,this.draft=this.initDraftModel(r,s),this.eventHandlers=n||{},this.view=new e.mail.Views.Compose(this.draft,this,s,r,i),this.service=new e.Mail.Services.Compose(NeoConfig.V3MailboxId),this.syncer=new e.mail.Compose.Syncer(this.draft,this.service),this.composeContentHelper=new e.mail.Controller.ComposeContentHelper(this),this.captchaRetryCount=0,this.attachInReply=!0,this.timers=[],this.hideComposeTimer,n&&this.bindComposeEvent()};E.prototype={save:x,send:T,edited:O,unedited:M,isSaving:_,isEdited:D,isPopulated:P,setDraftHeader:B,setDraftBody:H,initDraftModel:R,setMessageFromAddress:Z,setDraftOrigin:et,bindComposeView:I,bindComposeEvent:F,setParent:tt,handleEvent:U,handleFileUpload:X,handleFileUploadForm:V,willAttachmentOverflow:$,handleStateChange:J,autoAddContacts:Y,showCompose:nt,isOverMaxFileSize:it,getRteImagePlugin:rt,handleInlineImageAdded:j,injectDataIdFromImages:S,_validateSend:A,_findRealFileSize:z,_determineSize:W,_setAutoCC:q,_getAttachmentStatInfo:L,_getMessageType:C,_fireSendStats:N,destructor:ot,scheduleHideCompose:ut,cancelHideCompose:ft,_hideComposeTab:K,_showComposeNotification:Q,_unsetHideComposeTimer:at,_isComposeNotification:G,_destroyTimers:st},e.namespace("mail.Controller").ComposeController=E},"1.0.0",{requires:["mail-ui-fullcompose-v3","mail-models-validators-send","mail-model-datastore","mail-models-draft","mail-model-attachment","mail-services-compose","mail-services-plugins","mail-services-response-serializer","mail-compose-syncer","mail-controller-reply-processor","mail-controller-html-processor","mail-controller-text-processor","mail-controller-signature-processor","mail-controller-spell-processor","mail-ui-mailcompose-header-form-list-helper","mail-controller-composecontent-helper","mail-controller-inlineimage-processor","mail-common-utils-features","rte-file-utils","mail-ui-folder-utils","mail-controller-v3-user-settings"]});
YUI.add("mail-ui-authorview-v3",function(e){function f(){var t=this;t.closeChgHandler=t.on("closeChange",t.handleCloseChange,t),t.activeChangeHandler=t.on("activeChange",t.handleActiveChange),NeoConfig.hasConvView?t.msgsRemoveHandler=e.on("ds:conv:remove",t.handleConvRemove,t):t.msgsRemoveHandler=e.on("ds:msg:remove",t.handleMsgRemove,t)}function l(e){var t=this;e.newVal?(t.view.set("active",!0),t.view.showComposeView(e)):(t.view.set("active",!1),t.view.hideComposeView(e))}function c(e){var t=this;e.newVal&&t.view.closeCompose()}function h(e,t,n,r,i){var s,o=t||[],a;if(i&&i.reason==="savedraft")return;if(!u.isDraftFid(e))return;for(s=0;s<o.length;s++)a=o[s],this.view.getDraftMID()===a.mid&&this.set("close",1)}function p(e,t){var n,r=t||[],i;if(!u.isDraftFid(e))return;for(n=0;n<r.length;n++)i=r[n],i.totalMsgs===1&&this.view.getDraftMID()===i.recentmid&&this.set("close",1)}function d(e){var t="str_comp_nosubject",n=e||strings[t];this.set("title",n)}function v(e){this.set("direction",e)}function m(e){var t=this,n=t.localCharCodes.length,r;for(r=0;r<n;r++)if(e===t.localCharCodes[r])return!0;return!1}function g(){var e=this;if(e.view)return[e.view]}function y(t){var n=this,r=t.keyCode;r=n.keyCodesL10N[r]||r;switch(r){case 220:if(!t.altKey&&(t.metaKey||t.ctrlKey))return n.set("close",1),!0;break;case 27:return n.controller&&(n.controller.closeSrc="escKey"),(!e.ACWidgetInst.handleEscape||!e.ACWidgetInst.handleEscape())&&n.set("close",1),!0}return e.UA.ie&&n.view.onLocalKeyDown&&!n.view.onLocalKeyDown(t)?!1:n.view&&n.view.onKeyDown?n.view.onKeyDown(t):null}function b(e){return this.view.onFocus(e)}function w(){return this.view.isDirty()}function E(){return!this.isDirty()&&!this.view.hasContent()}function S(e){var t=this;return t.view.matchOrigin?t.view.matchOrigin(e):!1}function x(t,n){var r=this;return r.view=r.createComposeController(t,n).view,r.view.handles.push(r.view.on("renderComplete",function(){r.set("rootNode",r.get("parentNode").one("div.compose")),t&&t.postRender&&t.postRender(r,t),s.enabled("richcompose")&&(!r.view.get("isQuickReply")||s.enabled("richcomposeInQuickReply"))&&e.use("mail-ui-richcompose-view",function(e){!r.richcompose&&r.view&&(r.richcompose=new e.mail.Views.RichCompose(r,r.view))})})),t&&t.oMsg&&t.oMsg.header&&(t.oMsg.header.subject=e.mail.Controller.ReplyProcessor.seedSubject(t)),r.view}function T(t,n){var r=this,s=null,o;return i({m:"start creating ComposeController"}),o={keydownHandler:e.bind(r.onKeyDown,r)},s=new e.mail.Controller.ComposeController(r.get("parentNode"),r.getEventBindings(),t,o,n),s.handles=[],r.controller=s,s}function N(e){e.action=e.type,this.fire("darlaEvent",e)}function C(){var e=this;e.parent=e.get("parentNode"),e.controller.setParent(e.parent),e.controller.bindComposeView()}function k(t){var n=this,r=e.one(t);n.set("parentNode",r),n.set("rootNode",r.one("div.compose"));return}function L(){return}function A(e){var t=this;t.controller.composeViewTainer&&this.controller.composeViewTainer.one(".composeshim")[e?"removeClass":"addClass"]("hidden"),e?t.tab&&t.tab.elTab.addClass("sending"):t.tab&&t.tab.elTab.removeClass("sending")}function O(){var e=this,t=e.view.getSubjectInfo();t.subjectVal?(e.updateTabTitle(n(r(t.subjectVal))),t.subjectDir&&e.updateTabDirection(t.subjectDir)):(e.updateTabTitle(e.view.title),t.subjectDir&&e.updateTabDirection(""))}function M(){var e=this;e.msgsRemoveHandler&&e.msgsRemoveHandler.detach(),e.closeChgHandler&&e.closeChgHandler.detach(),e.toolBarHandler&&e.toolBarHandler.detach(),e.activeChangeHandler&&e.activeChangeHandler.detach(),e.view&&e.view.controller&&e.view.controller.destructor(),a.superclass.ondestroy.call(e,arguments)}function _(t){var i=this;i.updateTabTitle(n(r(t.subject))),NeoConfig.bidi&&i.updateTabDirection(e.Intl.detectDirection(t.subject))}function D(e){return this.view.canClose(e)}function P(t){e.fire("compose:rte:active",{editor:t.editor,cv:t.cv})}function H(e){var t=this;this.view.fire("composeWillClose"),e.forceClose&&t.set("forceClose",1),t.set("close",1)}function B(){var e=this;e.tab.set("viewable",!1)}function j(){var e=this;e.tab.set("viewable",!0)}function F(e){this.set("focusNode",e.focusNode)}function I(){this.tab!==e.mail.Tabs.getActiveTab()&&e.mail.Tabs.switchToTab(this.tab)}function q(t){var n=this;n.tab!==e.mail.Tabs.getActiveTab()?e.mail.Tabs.switchToTab(n.tab,t.sdcbk()):t.sdcbk()}function R(e){var t=this;e.sending?t.tab&&t.tab.elTab.addClass("sending"):(t.tab&&t.tab.elTab.removeClass("sending"),e.title?t.updateTabTitle(e.title):t.setSubjectAsTitle())}function U(){var t=this,n={updateSubject:e.bind(t.setSubjectAsTitle,t),closeAction:e.bind(t.closeAction,t),setActiveCompose:e.bind(t.setActiveCompose,t),qrCancel:e.bind(t.closeAction,t),replyheaderLoad:e.bind(t.replyheaderLoad,t),setFocusNode:e.bind(t.setFocusNode,t),showSaveDialog:e.bind(t.showSaveDialog,t),showCompose:e.bind(t.showCompose,t),addChild:e.bind(function(e){this.addChild(e.view)},t),removeChild:e.bind(function(e){this.removeChild(e.view)},t),updateTitle:e.bind(t.updateTitle,t),switchToTab:e.bind(t.switchToTab,t),darlaEvent:e.bind(t.fireDarlaEvent,t)};return o&&(n.hideAction=e.bind(t.hideAction,t),n.showAction=e.bind(t.showAction,t)),n}function z(){var e=this,t=e.view&&e.view.draft&&e.view.draft.folder.acctId;return t}var t=e.common.Utils,n=t.escapeHtml,r=t.unescapeHtml,i=t.log,s=t.features,o=s.enabled("instantCloseOnSend"),u=e.mail.ui.FolderUtils,a=function(t){var n=this,r;n.keyCodes=[],n.keyCodesL10N={},n.parent=null,n.view=null,n.controller=null,n.localCharCodes=[8,77,78,73,84],n.composeActive=!0,n.type="author",n.widgetType="compose",n.keyCodesL10N[strings.str_cfg_sc_keycode_save_as_draft]=83,n.keyCodesL10N[strings.str_cfg_sc_keycode_close_tab]=220;for(r in n.keyCodesL10N)n.keyCodes.push(r);a.superclass.constructor.call(n,t),n.bind(),n.set("charCodes","13,13+ctrl,13+meta,27,188+ctrl,190+ctrl,"+n.keyCodes.join("+ctrl,")+"+ctrl,"+n.keyCodes.join("+meta,")+"+meta"),e.UA.ie&&n.set("localCharCodes",n.localCharCodes.join()),n.updateTabTitle
(n.get("title"))};e.extend(a,e.mail.ui.BaseWidget),e.mix(a.prototype,{NAME:"AuthorView",ondestroy:M,onKeyDown:y,onFocus:b,bind:f,bindUI:L,render:k,initCompose:x,createComposeController:T,bindComposeView:C,isLocalCharCode:m,isDirty:w,isClean:E,matchOrigin:S,updateTabTitle:d,updateTabDirection:v,handleCloseChange:c,showComposeShim:A,getComposeWidgets:g,setSubjectAsTitle:O,setFocusNode:F,showSaveDialog:q,_canClose:D,closeAction:H,hideAction:B,showAction:j,setActiveCompose:P,handleActiveChange:l,replyheaderLoad:_,getEventBindings:U,updateTitle:R,switchToTab:I,handleConvRemove:p,handleMsgRemove:h,fireDarlaEvent:N,getDraftAcctId:z},!0),e.namespace("mail.ui"),e.mail.ui.AuthorViewConv=a},"1.0.0",{requires:["mail-controller-base","mail-controller-reply-processor","_shared_module_compose_title","mail-common-utils-features","mail-controller-compose-v3","mail-ui-folder-utils"]});
YUI.add("common-utils-onboarding",function(e){var t,n,r,i=e.mail.ui.FolderUtils,s=e.common.Utils.getSegmentData("webMail").currSegScore,o;o={setRestartBuckets:function(){return(new Promise(function(t){e.contacts.utils.areContactsLoaded()?t():e.once("contacts:api:loaded",t)})).then(function(){var s=0,o=i.get(i.getInboxFid()).total||0,u=i.get(i.getInboxFid()).unread||0,a=[100,500,1e3,5e3,1e4];e.contacts.utils.areContactsLoaded()&&(s=e.contacts.utils.getTotalContacts()),t=[10,50,100,500,1e3].filter(function(e){return s<e})[0]||"gt_1000",n=a.filter(function(e){return o<e})[0]||"gt_10000",r=a.filter(function(e){return u<e})[0]||"gt_10000"})},statRestartEligibility:function(){o.getRestartBuckets().then(function(){e.fire("util:ymstats",{name:"restart_eligible",tags:{contactsBucket:t,inboxCountBucket:n,unreadInboxCountBucket:r,segment:s}})})},getRestartBuckets:function(){return(new Promise(function(e){typeof t=="undefined"?e(o.setRestartBuckets()):e()})).then(function(){return{contactsBucket:t,inboxCountBucket:n,unreadInboxCountBucket:r}})}},e.namespace("common.Utils").Onboarding=o},"1.0.0",{requires:["common-utils","contacts-api","contacts-api-utils","mail-ui-folder-utils"]});
