YUI.add("mail-common-token-refresh",function(e){var t=e.common.Utils,n="metro",r="rushmore",i="fb_token_refresh",s;s={bodyNode:e.one("body"),facebookTokenRefreshEndPoint:t.settings.value("facebookTokenRefreshURL"),facebookAppIds:t.settings.value("facebookAppIDs"),metroSPID:t.settings.value("facebook_credstore_spid"),rushmoreSPID:t.settings.value("facebook_import_credstore_spid"),tokenValidityThreshold:t.settings.value("tokenValidityThreshold"),credStoreRedirectURI:t.settings.value("credStoreRedirectURI"),getAppName:function(e){var t=this;return e===t.rushmoreSPID?r:n},init:function(){var e=this;setTimeout(function(){e.insertIframe(e.metroSPID)},100),setTimeout(function(){e.insertIframe(e.rushmoreSPID)},5100)},insertIframe:function(t){var n=this,r=e.mail.common.ConnectedAccounts.getAllSPIDStatus(),i=864e5,s=n.getAppName(t),o,u,a,f,l;r?(o=r.results[t],o?o.is_expired===!1?(u=o.expiry_ts*1e3,a=Math.round((u-Date.now())/i),a<n.tokenValidityThreshold?(f=n.facebookTokenRefreshEndPoint+"&client_id="+n.facebookAppIds[t]+"&redirect_uri="+n.credStoreRedirectURI.replace("{{spid}}",t),l='<iframe id="'+t+'" src="'+f+'" height="0px" width="0px"></iframe>',n.bodyNode.append(l),setTimeout(function(){n.destroyIframe(t)},15e3),n.stat(s,"stale_token"),e.log("FB Token Refresh - App: "+s+" - Access token is getting stale. It will expire in "+a+" days.")):(n.stat(s,"valid_token"),e.log("FB Token Refresh - App: "+s+" - Access token is valid. It will expire in "+a+" days."))):n.stat(s,"expired_token"):n.stat(s,"app_not_linked")):n.stat("init","status_unavailable")},destroyIframe:function(e){var n=this,r=n.getAppName(e);t.remove(n.bodyNode.one("#"+e))},stat:function(t,n){e.fire("util:ymstats",{name:i,tags:{app:t,state:n}})}},e.namespace("mail.common"),e.mail.common.TokenRefresh=s},"1.0.0",{requires:["node","event","mail-common-connected-accounts"]});
