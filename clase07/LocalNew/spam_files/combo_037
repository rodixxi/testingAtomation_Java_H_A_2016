YUI.add("mail-common-cachewarmer",function(e){e.namespace("mail.common.cachewarmer");var t=5e3,n=3e3,r=10,i=NeoConfig.pfm,s=50,o=e.Env._loader,u={isIdle:function(){return!0}},a=e.common.net.Session||u,f={},l=e.on("ds:msg:remove",function(e,t){if(e==="Inbox")for(var n in t)f[t[n].mid]=!0}),c={},h=e.on("ds:conv:remove",function(e,t){if(e==="Inbox")for(var n in t)c[t[n].cid]=!0}),p=e.common.Utils.features,d=function(e){try{return function(){this.queue[e].apply(this.queue,arguments)}}catch(t){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-common-cachewarmer:1",t,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-common-cachewarmer:1")}return!1};e.mail.common.cachewarmer={queue:function(){var t=new e.AsyncQueue;return t.defaults.timeout=s,t}(),add:function(){return this.queue.add.apply(this.queue,arguments),this},run:function(){return this.queue.add(this.queue.stop),this.queue.run(),this},clear:function(){this.queue.stop(),e.detach("cachewarmer:stopMessagePrefetch")},warmUp:function(t,n,i,s){return i&&this.addDelay(i),!s&&this.addIdleCheck(r,!0),e.Lang.isArray(n)&&n.length?(this.queue.add({fn:function(){e.use.apply(e,n)},timeout:10,id:t}),this):!1},addDelay:function(e){return e?(this.queue.add({fn:function(){},timeout:e}),!0):!1},addIdleCheck:function(e,t){var n=0,i=this.queue;return e=e||r,i.add({fn:function(){n++},timeout:400,until:function(){return a.isIdle()&&(!o||!o._loading)?!0:n===e?(t||i.stop(),!0):!1}}),!0},setupLaunch:function(e){return this.addDelay(e?n:t),this.addIdleCheck(),!0},preFetchMessages:function(e,t,n,r){if(NeoConfig.hasConv)return;return this.clear(),n&&this.addDelay(n),e==="Inbox"&&!t?this.addInboxPreFetching():this._preFetchMessages(e,t,r),this.run()},addInboxPreFetching:function(){var t=this;NeoConfig.hasConv&&NeoConfig.hasConvPerf?t._preFetchConvs("Inbox",e.mail.ui.ConvList.getConvHdrList(),null,!0):NeoConfig.hasConv||t._preFetchMessages("Inbox",e.mail.ui.MessageList.getMsgHdrList(),null,!0)},_preFetchConvs:function(t,n,r,s){function w(n,r,i){var s=function(){var s=[],o;for(o in n)c[n[o].cid]||s.push(n[o]);if(s.length>0)if(p.enabled("yodaConversationRead")&&NeoConfig.loadYodaController)NeoConfig.loadYodaController.then(function(){e.mail.controller.v3.api.getConversations({items:s,getDisplay:!0,isPrefetchCall:!0,showTAE:!1,statTAE:!1,success:function(){r&&e.fire("launch:messagePrefetchCompleted")}})});else{f=e.mail.Controller.batch(),f.setAsReadOp(!0);for(o=0;o<s.length;o++)e.mail.model.ConvStore.Conversations.isCached(t,s[o].cid)||e.mail.Controller.Conversations.batchAddConvPrefetch(f,o,t,s[o],"CacheWarmer");f.execute({suppressCodes:["*"],backgroundLogs:["*"]})}r&&e.detach(i)};this.timeout=100,this.id="convsPrefetch",this.fn=s}var o,u,a=[],f,l,d,v,m=i.batch.split(","),g=i.count,y=i.maxSize,b=e.mail.ui.ConvList;r&&r[0]?a=r:b&&n&&b.getNeighbors(n,-1,a,t,g,y);while((v=m.shift()||10)&&(d=a.splice(0,v))&&(u=d.length)){l=[];for(o=0;o<u;o++)l.push(d[o]);this.addIdleCheck(5,!0),this.queue.add(new w(l,s,h))}return e.once("cachewarmer:stopMessagePrefetch",function(t){var n=["convsPrefetch"];this.queue.remove("convsPrefetch"),this.clear(),!e.Lang.isUndefined(t)&&e.Lang.isFunction(t.done)&&(e.Lang.isUndefined(t.data)||n.push(t.data),t.done.apply(this,n))},this),this.queue.on("complete",function(){e.detach("cachewarmer:stopMessagePrefetch")}),!0},_preFetchMessages:function(t,n,r,s){function o(n,r,i){var s=function(){var s=[];for(var o in n)f[n[o].mid]||s.push(n[o]);s.length>0&&(NeoConfig.yodaReadEnabled&&NeoConfig.yodaControllerLoaded?e.mail.controller.v3.api.getSimpleBodyofMessages({messageList:s,sourceFid:t,isPrefetchCall:!0,statTAE:!1,showTAE:!1,success:function(){r&&e.fire("launch:messagePrefetchCompleted")}}):e.mail.Controller.Messages.get({fid:t,prefetch:s,cachekey:"CacheWarmer"},{suppressCodes:["*"],backgroundLogs:["*"]})),r&&e.detach(i)};this.timeout=10,this.id="messagePrefetch",this.fn=s}if(!i||NeoConfig.hasConv)return!1;NeoConfig.grid&&(i.batch="6,6",i.count=12);var u,a,c=[],h,p,d,v=i.batch.split(","),m=i.count,g=i.maxSize,y=e.mail.ui.MessageList;r&&r[0]?c=r:y&&n&&y.getNeighbors(n,-1,c,t,m,g);while((d=v.shift()||10)&&(p=c.splice(0,d))&&(a=p.length)){h=[];for(u=0;u<a;u++)h.push(p[u]);this.addIdleCheck(5,!0),this.queue.add(new o(h,s,l))}return e.once("cachewarmer:stopMessagePrefetch",function(t){var n=["messagePrefetch"];this.queue.remove("messagePrefetch"),this.clear(),!e.Lang.isUndefined(t)&&e.Lang.isFunction(t.done)&&(e.Lang.isUndefined(t.data)||n.push(t.data),t.done.apply(this,n))},this),this.queue.on("complete",function(){e.detach("cachewarmer:stopMessagePrefetch")}),!0},before:d("before"),on:d("on"),after:d("after"),fire:d("fire")}},"1.0.0",{requires:["async-queue","loader","common-net-session","mail-controller-messages","mail-common-utils-features"]});
