YUI.add("mail-ui-heartbeat",function(e){var t=e.common.Utils,n=t.settings,r,i=60,s=-1,o={},u=!1,a=t.parseQueryString()||{},f=1,l=6e4,c=60*l,h=24*c,p=["heartBeat","heartBeatRefresh","heartBeatForceRefresh","heartBeatInterval","heartBeatIdleTime","heartBeatForceRefreshIdleTime","heartBeatForceRefreshDays"];r=function(){function r(){NeoGV.launchTime=Date.now(),NeoGV.lastActiveTime=NeoGV.launchTime,NeoGV.isWindowFocused=!0,i=l*n.value("heartBeatInterval",60),i<1&&(i=l*60),setInterval(d,i)}function d(){var t=Date.now(),r=Math.floor((t-NeoGV.launchTime)/c),i=Math.floor((t-NeoGV.launchTime)/h),s={ver:f,env:NeoConfig.mailEnv,sbn:NeoConfig.buildNumber,fbn:n.value("featureFlipperVersion").substr(1),tbn:"tbn",now:t,nDay:i,nHour:r,winapp:NeoConfig.isWinApp,lastActiveTime:NeoGV.lastActiveTime};o={ver:f,farm:NeoConfig.farm&&NeoConfig.farm.substr(1),sbn:NeoConfig.buildNumber,fbn:n.value("featureFlipperVersion").substr(1),day:i,hour:r,winapp:NeoConfig.isWinApp,launchtime:NeoGV.launchTime,now:t};if(r<0||i<0){E("heartbeat_error:negative_value","info");return}y(i),b(r),e.Array.forEach(p,function(t){e.Lang.isUndefined(a[t])||(s[t]=a[t])}),e.io("heartbeat",{method:"GET",data:s,on:{success:v,failure:m}})}function v(t,n){var r;try{r=e.JSON.parse(n.responseText),r.latestBuildNumber&&(NeoGV.latestBuildNumber=r.latestBuildNumber),r.forceRefresh&&!NeoGV.isWindowFocused?(w("forceRefresh"),E("heartbeat_forceRefresh","critical"),NeoConfig.isWinApp?e.use("mail-ui-windows-helper",function(e){e.mail.ui.windows.helper.appNotify("mailRefresh")}):window.location.reload(!0)):r.refresh&&!NeoGV.isWindowFocused&&!u&&g()}catch(i){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-heartbeat-heartbeat:1",i,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-heartbeat-heartbeat:1")}}function m(){E("heartbeat_error:xhr_failure","critical")}function g(){e.use("common-ui-dialog-helper",function(e){e.common.ui.DialogHelper.confirm({hd:t.substitute(strings.str_heartbeat_dialog_header,null,null,null,strings),bd:strings.str_heartbeat_dialog_body},{ok:{text:strings.str_heartbeat_btn_reload,handler:function(){w("reload"),E("heartbeat_reload","critical"),NeoConfig.isWinApp?e.use("mail-ui-windows-helper",function(e){e.mail.ui.windows.helper.appNotify("mailRefresh")}):window.location.reload(!0)}},cancel:{text:strings.str_heartbeat_btn_later,handler:function(){w("later"),u=!1}}}),u=!0}),w("show")}function y(t){t>s&&(s=t,e.fire("util:ymstats",{name:"heartbeat_daily",tags:{day:t},include:{farm:!0}}),E("heartbeat_daily","info"))}function b(t){e.fire("util:ymstats",{name:"heartbeat_hourly",tags:{hour:t},include:{farm:!0}}),E("heartbeat_hourly","info")}function w(t){e.fire("util:ymstats",{name:"heartbeat_ui",tags:{action:t,isWinApp:NeoConfig.isWinApp},include:{farm:!0}})}function E(t,n){e.fire("SplunkLog",t,o,n)}e.mix(this,{init:r})},e.namespace("mail.ui").heartBeat=new r},"1.0.0",{requires:["ymma-stats","mail-common-utils-features"]});
