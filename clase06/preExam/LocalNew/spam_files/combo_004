YUI.add("mail-ui-desktop-notifications-mail",function(e){function T(t){return!e.Lang.isArray(t)||t.length===0?!1:!0}function N(e){return typeof t.getVal(e,"from.name")=="undefined"||typeof t.getVal(e,"from.email")=="undefined"?!1:!0}function C(e){var t=!0,n,r;if(!T(e))return null;if(e[0].cid===undefined)return null;if(e.length===1)return!0;r=e[0].cid;for(n=1;n<e.length;n++){if(!e[n].cid)return null;if(e[n].cid!==r){t=!1;break}}return t}function k(e){var t=[],n={},r=0,i=0,o,u,a;if(!T(e))return null;o=e.length;for(u=0;u<o;u++){if(!N(e[u]))return null;a=e[u].from.name.trim()!==""?e[u].from.name:e[u].from.email;if(a.trim()==="")continue;if(s-(16+t.length*2+i+a.length+2)<0)continue;a in n?(n[a]++,r++):(n[a]=1,t.push(a),i+=a.length)}return L(e,t,r)}function L(e,n,r){var i,s,o;return n.length===0?"":n.length!==1||n.length!==e.length&&r+1!==e.length?n.length+r<e.length?(s=e.length-(n.length+r),s===1?(i=strings.str_notif_other,t.ezSub(i,{comma_separated_recipient_list:n.join(", ")})):(i=strings.str_notif_others,t.ezSub(i,{comma_separated_recipient_list:n.join(", "),num_others:String(s)}))):(i=strings.str_notif_recipients,o=n.pop(),t.ezSub(i,{comma_separated_recipient_list:n.join(", "),single_recipient:o})):(i=strings.str_notif_recipient,t.ezSub(i,{single_recipient:n[0]}))}function A(t){e.fire("openMessage",{fid:t[0].folderInfo.fid||n.getInboxFid(),isConv:0,msg:t[0]}),window.focus()}function O(){e.fire("openInbox"),window.focus()}function M(t){e.fire("openConv",{fid:t[0].fid||n.getInboxFid(),isConv:1,isThread:!0,msg:t[0]}),window.focus()}function _(t,n){e.fire("util:ymstats",{name:"notifications_click_invoke",tags:{isWinApp:NeoConfig.isWinApp,agent:m}}),NeoConfig.hasConvView?t.length>1&&!C(n)?O():M(t):t.length>1?O():A(t)}function D(e){var n;return T(e)?e.length>1?(n=strings.str_notif_new_msg,t.ezSub(n,{num_new_msgs:String(e.length)})):N(e[0])?e[0].from.name.trim()!==""?e[0].from.name:e[0].from.email:null:null}function P(t){return T(t)?t.length>1?k(t):e.common.Utils.getVal(t[0],"subject")?t[0].subject:"":null}function H(){var n=o,r,s,a=u,f,l,c,p;c=function(e){var t=NeoConfig.hasConvView?e.msgs[0].from.email:e.from.email;return v.indexOf(t)>-1},p=function(e){var t=NeoConfig.hasConvView?e.msgs[0].classification:e.classification,n=t&&t.category;return n&&n.indexOf("P")>-1},b?n=n.filter(c):w&&(n=n.filter(p)),NeoConfig.hasConvView?r=n.reduce(function(e,t){return e.concat(t.msgs)},[]):r=n;if(!n||n.length===0)return;E=D(r),S=P(r);if(E===null||S===null)return;s=function(){o=[],_(n,r)},NeoConfig.isWinApp?r.length!==1?i=new window.Notification(E,{body:S}):(f=r[0],i=new window.Notification(E,{body:S,email:f&&f.from.email,tag:f&&f.mid,receivedDate:f&&f.receivedDate})):(t.features.enabled("mosaicNotifications")?l=B(r):l=r.length===1?j(r[0].from.email):undefined,i=h.notify(E,S,s,a,l)),e.fire("util:ymstats",{name:"notifications_notify_invoke",tags:{agent:m,isWinApp:NeoConfig.isWinApp,length:r.length}})}function B(n){var r,i,s,o,u,a=[];r=n.map(function(e){return e.from.email}).filter(function(e,t,n){return n.indexOf(e)===t}),u=r.slice(0,4);for(var f=0;f<u.length;f++)e.comms.Utils.isValidEmail(u[f])&&a.push("smtp:"+encodeURIComponent(u[f]));return i=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/mosaic?endpoints="+a.join(","),i+="&total="+r.length+"&badge=true&spsize=",o=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(o*=2),i+=o+"x"+o,s=t.settings.value("yahooMailNotificationLogo")+o+"x"+o+"_2.png",i+="&fallback_url="+s,i+="&ymreqid="+e.common.net.Session.genReqID(),i}function j(n){var r,i,s;return r=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/smtp:"+n+"/photo?format=image&badge=true&spsize=",s=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(s*=2),r+=s+"x"+s,i=t.settings.value("yahooMailNotificationLogo")+s+"x"+s+"_2.png",r+="&fallback_url="+i,r}function F(t){this.watermark=t.getMostRecentTimestamp(),t.on("MailList:modelRefresh",this.onListRefresh,this),NeoConfig.multipleAccounts&&e.on("accounts:select",function(){x&&x.detach(),x=t.once("renderComplete",function(){this.watermark=t.getMostRecentTimestamp()},this)},this)}function I(t){var n;if(!R())e.use("mail-ui-onboarding-desktop-notification",function(){n=e.mail.ui.onboarding.mailDesktopNotificationOnboard,n.init(n.calloutType.AUTO_CHECK_MAIL),f=!1});else if(!NeoConfig.isWinApp&&window.Notification.permission==="default"&&h.getSavedPreference()==="granted")h.getUserPermission(function(t){e.fire("util:ymstats",{name:"notifications_permission_"+t,tags:{agent:m}})});else{if(!T(t))return;l||(o.unshift.apply(o,t),e.mail.ui.mailDesktopNotifications.notify())}}function q(e){if(!e||typeof e.list=="undefined")return;var t=e.list.getNewMsgs(this.watermark),r=e.list.getMostRecentTimestamp();r&&n.isInboxFid(e.list.fid)&&(this.watermark=r),this.handleNotify(t)}function R(){return NeoConfig.isWinApp||!f||h.getSavedPreference()==="granted"}function U(){return new Promise(function(e){yui.xobniContacts.searchAPI.getImportantContacts({},function(t){var n=[],r=[],i,s,o;for(s=0;s<t.length;s++)for(o=0;o<t[s].endpoints.length;o++)t[s].endpoints[o].ep.indexOf("smtp:")!==-1?(i=t[s].endpoints[o].ep.replace(/smtp:/i,""),n=n.concat(i)):n=n.concact(t[s].endpoints[o].ep);n.length?(n.forEach(function(e){r.push("fromaddress:"+e)}),e(("("+r.join(" ")+")").replace(/\+/g,""))):e("")},function(){e("")})})}function z(e){v=e.split(" ").map(function(e){return e.slice(e.indexOf(":")+1)})}function W(){var e;y?U().then(function(e){z(e)}):(e=r.get("importantQuery"),e?z(e):U().then(function(e){z(e)}))}function X(){c.on("blur",function(){l=!1}),p&&W(),c.on("focus",function(){l=!0,i&&!NeoConfig.isWinApp&&i.close(),o=[]}),h.currentBrowserNeedsPermission()&&(h.getUserPermission(),e.fire("util:ymstats",{name:"notifications_login_new_browser",tags:{agent:m}})),e.namespace("mail.ui").mailDesktopNotifications={isFromSameConv:C,init:F,onListRefresh
:q,handleNotify:I,getRecepientList:k,openView:_,getTitle:D,getBody:P,getMosaicUrl:B,notify:H},f=!r.get(a)}var t=e.common.Utils,n=e.mail.ui.FolderUtils,r=e.mail.persist.MetaData,i=null,s=90,o=[],u="notification.mail",a="neo.pref.mailDesktopNotification.onboard",f=!1,l=!0,c=e.one("window"),h=e.mail.ui.desktopNotifications,p=t.features.enabled("importantNotifications"),d=t.features.enabled("peopleNotifications"),v=[],m=NeoConfig.browser&&NeoConfig.browser.split("_")[0],g=e.mail.controller.v3.settings.userSettings,y=t.features.enabled("isMetaDataMigrated")||NeoConfig.forceToV3UserSetting,b=p&&(y?g.getSync("attributes.web.importantNotification",!1):r.get("notificationType")==="important"),w=d&&(y?g.getSync("attributes.web.peopleNotification",!1):r.get("notificationType")==="people"),E,S,x;NeoConfig.browser.toLowerCase().indexOf("safari")!==-1&&(s=45),(h.browserSupportNotification()||NeoConfig.isWinApp)&&X()},"1.0.0",{requires:["mail-ui-desktop-notifications","cookie","comms-utils","common-utils","xobni-utilities","mail-ui-folder-utils","ymma-stats","mail-persist-meta-data","mail-controller-v3-user-settings"]});
